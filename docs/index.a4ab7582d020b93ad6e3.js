try{let e="undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof globalThis?globalThis:"undefined"!=typeof self?self:{},t=(new e.Error).stack;t&&(e._sentryDebugIds=e._sentryDebugIds||{},e._sentryDebugIds[t]="338893b4-cfba-4d01-963a-9208e75e9bb3",e._sentryDebugIdIdentifier="sentry-dbid-338893b4-cfba-4d01-963a-9208e75e9bb3")}catch(e){}!function(){var e={262:function(e){function t(e,t){t=t||2;let a=e.toString(),s=0;return s=t-a.length+1,a=new Array(s).join("0").concat(a),a}e.exports=function(e,a){const s=a&&a.leading,i=a&&a.ms,r=e<0?-e:e,o=function(e,t){return t?e<0?"-":"":e<=-1e3?"-":""}(e,i),n=function(e){if("number"!=typeof e)throw new TypeError("Expected a number");return{days:Math.trunc(e/864e5),hours:Math.trunc(e/36e5)%24,minutes:Math.trunc(e/6e4)%60,seconds:Math.trunc(e/1e3)%60,ms:Math.trunc(e)%1e3}}(r),c=t(n.seconds);let d="";return n.days&&!d&&(d=o+n.days+":"+t(n.hours)+":"+t(n.minutes)+":"+c),n.hours&&!d&&(d=o+(s?t(n.hours):n.hours)+":"+t(n.minutes)+":"+c),d||(d=o+(s?t(n.minutes):n.minutes)+":"+c),i&&(d+="."+t(n.ms,3)),d}}},t={};function a(s){var i=t[s];if(void 0!==i)return i.exports;var r=t[s]={exports:{}};return e[s](r,r.exports,a),r.exports}a.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return a.d(t,{a:t}),t},a.d=function(e,t){for(var s in t)a.o(t,s)&&!a.o(e,s)&&Object.defineProperty(e,s,{enumerable:!0,get:t[s]})},a.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},function(){"use strict";const e=async(e,t)=>`organisationIdHash=${await e.read(t,l.ORGANISATION_HASH)}&boardIdHash=${await e.read(t,l.BOARD_HASH)}`,t=(e,t,a)=>{const s=a.value,i="AsyncFunction"===s.constructor.name,r=`Leaner Coffee Power-Up: error in ${t} (reported)`;return a.value=i?async function(...e){try{return await s.apply(this,e)}catch(e){console.warn(r),window.Sentry.captureException(e)}}:function(...e){try{return s.apply(this,e)}catch(e){console.warn(r),window.Sentry.captureException(e)}},a};function s(e){const a=e.prototype;return Object.getOwnPropertyNames(a).filter((e=>"function"==typeof a[e]&&"constructor"!==e)).forEach((e=>{const s=Object.getOwnPropertyDescriptor(a,e);if(s&&"function"==typeof s.value){const i=t(0,e,s);Object.defineProperty(a,e,i)}})),e}const i=e=>{const t=e.constructor.prototype;Object.getOwnPropertyNames(t).filter((e=>"function"==typeof t[e]&&"constructor"!==e)).forEach((a=>t[a]=t[a].bind(e)))};var r,o=function(e,t,a,s){var i,r=arguments.length,o=r<3?t:null===s?s=Object.getOwnPropertyDescriptor(t,a):s;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)o=Reflect.decorate(e,t,a,s);else for(var n=e.length-1;n>=0;n--)(i=e[n])&&(o=(r<3?i(o):r>3?i(t,a,o):i(t,a))||o);return r>3&&o&&Object.defineProperty(t,a,o),o};let n=r=class{constructor(e="member",t="private"){Object.assign(this,{scope:e,visibility:t}),i(this)}canWrite(e){return"member"===this.scope||e.memberCanWriteToModel(this.scope)}static async getMemberType(e){const t=await e.board("memberships"),a=await e.member("id"),s=t.memberships.find((e=>e.idMember===a.id));return s?s.memberType:"unknown"}read(e,t,a){return e.get(a??this.scope,this.visibility,t)}async write(e,t,a,s){"memberCanWriteToModel"in e||window.Sentry.addBreadcrumb({category:"database",message:`Unknown permissions when trying to save "${t}" to the "${this.scope}" ${this.visibility} scope"`,level:"warning"}),!("memberCanWriteToModel"in e)||this.canWrite(e)?await e.set(s??this.scope,this.visibility,t,a):window.Sentry.captureException(new Error("Error while editing scope"),{contexts:{WriteOperation:{scope:this.scope,visibility:this.visibility,key:t,hasCardId:!!s,memberType:await r.getMemberType(e)}}})}async writeMultiple(e,t,a){"memberCanWriteToModel"in e||window.Sentry.addBreadcrumb({category:"database",message:`Unknown permissions when trying to save "${Object.keys(t).join(", ")}" to the "${this.scope}" ${this.visibility} scope`,level:"warning"}),!("memberCanWriteToModel"in e)||this.canWrite(e)?await e.set(a??this.scope,this.visibility,t):window.Sentry.captureException(new Error("Error while editing scope"),{contexts:{WriteOperation:{scope:this.scope,visibility:this.visibility,key:Object.keys(t),hasCardId:!!a,memberType:await r.getMemberType(e)}}})}async delete(e,t,a){if("memberCanWriteToModel"in e||window.Sentry.addBreadcrumb({category:"database",message:`Unknown permissions when trying to save "${t}" to the "${this.scope}" ${this.visibility} scope"`,level:"warning"}),!("memberCanWriteToModel"in e)||this.canWrite(e))return e.remove(a??this.scope,this.visibility,t);window.Sentry.captureException(new Error("Error while editing scope"),{contexts:{DeleteOperation:{scope:this.scope,visibility:this.visibility,key:t,hasCardId:!!a,memberType:await r.getMemberType(e)}}})}async deleteMultiple(e,t,a){if("memberCanWriteToModel"in e||window.Sentry.addBreadcrumb({category:"database",message:`Unknown permissions when trying to save "${Object.keys(t).join(", ")}" to the "${this.scope}" ${this.visibility} scope`,level:"warning"}),!("memberCanWriteToModel"in e)||this.canWrite(e))return e.remove(a??this.scope,this.visibility,t);window.Sentry.captureException(new Error("Error while editing scope"),{contexts:{DeleteOperation:{scope:this.scope,visibility:this.visibility,key:Object.keys(t),hasCardId:!!a,memberType:await r.getMemberType(e)}}})}};n=r=o([s],n);var c=n;class d extends c{constructor(){super("board","shared")}}d.DISCUSSION_STATUS="leancoffeeDiscussionStatus",d.DISCUSSION_CARD_ID="leancoffeeDiscussionCardId",d.DISCUSSION_STARTED_AT="leancoffeeDiscussionStartedAt",d.DISCUSSION_PREVIOUS_ELAPSED="leancoffeeDiscussionPreviousElapsed",d.DISCUSSION_INTERVAL_ID="leancoffeeDiscussionIntervalId",d.POWER_UP_INSTALLATION_DATE="powerUpInstallationDate",d.ORGANISATION_HASH="organisationHash",d.BOARD_HASH="boardHash";var l=d;class u extends c{constructor(){super("card","shared")}}u.DISCUSSION_STATUS="leancoffeeDiscussionStatus",u.DISCUSSION_ELAPSED="leancoffeeDiscussionElapsed",u.DISCUSSION_THUMBS="leancoffeeDiscussionThumbs",u.VOTES="leancoffeeVotes",u.DISCUSSION_BUTTON_LABEL="discussionButtonLabel";var h=u;const S=e=>{const t=new URL(e);return t.protocol+t.hostname+(t.port?`:${t.port}`:"")+t.pathname};var w={beforeSend:(e,t)=>({...t,referrer:window.LeanerCoffeeAnalyticsReferrer,hostname:window.LeanerCoffeeAnalyticsHostname,url:S(t.url)}),pageview:async(e,t={})=>{e.umami?await e.umami.track((e=>({...e,...t}))):console.warn("Umami not available for pageview",t)},event:async(e,t,a)=>{e.umami?await e.umami.track(t,a):console.warn("Umami not available for event "+t,a)},getOverrides:async(e,t)=>{const a=await e.read(t,l.ORGANISATION_HASH),s=await e.read(t,l.BOARD_HASH);return`referrer=${encodeURIComponent("https://"+a)}&hostname=${s}`}};const p=864e5,g=6048e5,b=2592e6,f=15552e6,y=31536e6,m=63072e6,I=15768e7;var O=function(e){switch(!0){case e<p:return"Less than a day";case e>=p&&e<g:return"Between a day and a week";case e>=g&&e<b:return"Between a week and a month";case e>=b&&e<f:return"Between a month and six months";case e>=f&&e<y:return"Between six months and a year";case e>=y&&e<m:return"Between one and two years";case e>=m&&e<I:return"Between two and five years";case e>=I:return"More than five years";default:return"Invalid duration"}};const{supportedLocales:D}={hostname:"https://leaner-coffee.tatablack.net",defaultDuration:3e5,supportedLocales:["en","it"]},v={defaultLocale:"en",supportedLocales:D,resourceUrl:"/i18n/{locale}.json"};var U=function(e,t,a,s){var i,r=arguments.length,o=r<3?t:null===s?s=Object.getOwnPropertyDescriptor(t,a):s;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)o=Reflect.decorate(e,t,a,s);else for(var n=e.length-1;n>=0;n--)(i=e[n])&&(o=(r<3?i(o):r>3?i(t,a,o):i(t,a))||o);return r>3&&o&&Object.defineProperty(t,a,o),o};let T=class{constructor(e){this.powerUp=e,i(this)}async boardButtonsHandler(e){return await this.powerUp.versionChecker.isThereANewMinorOrMajor(e)?[{icon:{dark:`${this.powerUp.baseUrl}/assets/moka_white.svg`,light:`${this.powerUp.baseUrl}/assets/moka.svg`},text:e.localizeKey("boardButtonLabel"),callback:this.powerUp.versionChecker.showMenu}]:[]}async cardBackSection(e){return void 0===await this.powerUp.discussion.cardStorage.read(e,h.DISCUSSION_STATUS)?null:{title:e.localizeKey("discussion"),icon:`${this.powerUp.baseUrl}/assets/powerup/timer.svg`,content:{type:"iframe",url:e.signUrl(`${this.powerUp.baseUrl}/discussion-ui.html?${await w.getOverrides(this.powerUp.boardStorage,e)}`)}}}async cardBadges(e){return[await this.powerUp.elapsedCardBadge.render(e),await this.powerUp.votingCardBadge.render(e)].filter((e=>e))}async cardButtons(e){return[{icon:`${this.powerUp.baseUrl}/assets/powerup/timer.svg`,text:await this.powerUp.getButtonLabel(e),callback:this.powerUp.handleDiscussion},{icon:`${this.powerUp.baseUrl}/assets/powerup/heart.svg`,text:e.localizeKey("vote",{symbol:await this.powerUp.voting.hasCurrentMemberVoted(e)?"☑":"☐"}),callback:this.powerUp.handleVoting}]}async cardDetailBadges(e){return[await this.powerUp.elapsedCardDetailBadge.render(e),await this.powerUp.votingCardDetailBadge.render(e)].filter((e=>e))}async listActions(e){return Promise.resolve([{text:e.localizeKey("clearVotesFromList"),callback:async e=>{(await e.list("cards")).cards.forEach((({id:t})=>{this.powerUp.cardStorage.deleteMultiple(e,[h.VOTES],t)})),await w.event(window,"listVotesCleared")}}])}async listSorters(e){return Promise.resolve([{text:e.localizeKey("sortByVote"),callback:async(e,t)=>{const a=(await Promise.all(t.cards.map((async t=>({leanCoffeeVotes:await this.powerUp.voting.countVotesByCard(e,t.id),id:t.id}))))).sort(((e,t)=>e.leanCoffeeVotes<t.leanCoffeeVotes?1:t.leanCoffeeVotes<e.leanCoffeeVotes?-1:0));return await w.event(window,"listVotesSorted"),{sortedIds:a.map((e=>e.id))}}}])}async onEnable(e){await navigator.locks.request("powerup_init",{ifAvailable:!0},(async t=>{const a=!!await this.powerUp.boardStorage.read(e,l.POWER_UP_INSTALLATION_DATE);null===t||a||a||await this.powerUp.handlePowerupEnabled(e)})),await w.event(window,"enabled")}async onDisable(e){const t=await this.powerUp.boardStorage.read(e,l.POWER_UP_INSTALLATION_DATE);await w.event(window,"disabled",{installedFor:O(Date.now()-Date.parse(t))})}async showSettings(e){return e.popup({title:"Leaner Coffee 0.9.8",url:`${this.powerUp.baseUrl}/settings.html?${await w.getOverrides(this.powerUp.boardStorage,e)}`,height:184,args:{localization:v}})}getAll(){return{"board-buttons":this.boardButtonsHandler,"card-back-section":this.cardBackSection,"card-badges":this.cardBadges,"card-buttons":this.cardButtons,"card-detail-badges":this.cardDetailBadges,"list-actions":this.listActions,"list-sorters":this.listSorters,"on-enable":this.onEnable,"on-disable":this.onDisable,"show-settings":this.showSettings}}};T=U([s],T);var C=T;class _ extends c{constructor(){super("member","private")}}_.POWER_UP_VERSION="powerUpVersion";var A=_,E=function(e,t,a,s){var i,r=arguments.length,o=r<3?t:null===s?s=Object.getOwnPropertyDescriptor(t,a):s;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)o=Reflect.decorate(e,t,a,s);else for(var n=e.length-1;n>=0;n--)(i=e[n])&&(o=(r<3?i(o):r>3?i(t,a,o):i(t,a))||o);return r>3&&o&&Object.defineProperty(t,a,o),o};let N=class{constructor({w:e,config:t}){this.w=e,this.config=t,this.boardStorage=new l,this.cardStorage=new h,this.memberStorage=new A,i(this)}};N=E([s],N);var R=a(262),P=a.n(R),B=function(e,t,a,s){var i,r=arguments.length,o=r<3?t:null===s?s=Object.getOwnPropertyDescriptor(t,a):s;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)o=Reflect.decorate(e,t,a,s);else for(var n=e.length-1;n>=0;n--)(i=e[n])&&(o=(r<3?i(o):r>3?i(t,a,o):i(t,a))||o);return r>3&&o&&Object.defineProperty(t,a,o),o};let L=class{constructor(e){this.getText=async(e,t)=>P()(t),this.getColor=async e=>await this.discussion.isOngoingFor(e)?"orange":await this.discussion.isPausedFor(e)?"yellow":"light-gray",this.discussion=e,this.render=this.render.bind(this),i(this)}async render(e){const t=await this.discussion.getElapsed(e);return Number.isFinite(t)?{text:await this.getText(e,t),color:await this.getColor(e)}:null}};L=B([s],L);var $=L;var x=class extends ${constructor(){super(...arguments),this.render=async e=>{const t=await this.discussion.cardStorage.read(e,h.DISCUSSION_STATUS);if("ENDED"!==t)return null;const a=await super.render(e);return null===a?(window.Sentry.captureMessage("Inconsistent data",{contexts:{CardDetailBadge:{discussionStatus:t,discussionElapsed:await this.discussion.cardStorage.read(e,h.DISCUSSION_ELAPSED),discussionButtonLabel:await this.discussion.cardStorage.read(e,h.DISCUSSION_BUTTON_LABEL),memberType:await c.getMemberType(e)}}}),null):(a.title=e.localizeKey("discussionDurationTitle"),a)}}},V=function(e,t,a,s){var i,r=arguments.length,o=r<3?t:null===s?s=Object.getOwnPropertyDescriptor(t,a):s;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)o=Reflect.decorate(e,t,a,s);else for(var n=e.length-1;n>=0;n--)(i=e[n])&&(o=(r<3?i(o):r>3?i(t,a,o):i(t,a))||o);return r>3&&o&&Object.defineProperty(t,a,o),o};let M=class{constructor(e,t,a,s,r){this.getVoters=async e=>{const t=await this.voting.getVotes(e)||{};return Object.values(t).reduce(((e,t)=>(t.username&&e.push({text:`${t.fullName} (${t.username})`,avatar:t.avatar}),e)),[])},this.w=e,this.baseUrl=t,this.voting=a,this.boardStorage=s,this.cardStorage=r,this.render=this.render.bind(this),i(this)}async render(e){const t=await this.getVoters(e);if(!t.length)return null;const a=await this.voting.hasCurrentMemberVoted(e);return{text:t.length.toString(),color:a?"blue":null,icon:`${this.baseUrl}/assets/powerup/${a?"heart_white.svg":"heart.svg"}`}}};M=V([s],M);var k=M;var j=class extends k{constructor(){super(...arguments),this.clearVoters=async e=>{const t=await this.getVoters(e);await this.cardStorage.delete(e,h.VOTES),await w.event(this.w,"votesCleared",{total:t.length})},this.showVoters=async t=>{const a=await this.getVoters(t);a.length&&await t.popup({title:t.localizeKey("voters"),url:`./voters.html?${await w.getOverrides(this.boardStorage,t)}&${await e(this.boardStorage,t)}`,args:{items:a,localization:v},callback:this.clearVoters})},this.render=async e=>{const t=await super.render(e);return t&&(t.title=e.localizeKey("voters"),delete t.icon,t.callback=this.showVoters),t}}},H=function(e,t,a,s){var i,r=arguments.length,o=r<3?t:null===s?s=Object.getOwnPropertyDescriptor(t,a):s;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)o=Reflect.decorate(e,t,a,s);else for(var n=e.length-1;n>=0;n--)(i=e[n])&&(o=(r<3?i(o):r>3?i(t,a,o):i(t,a))||o);return r>3&&o&&Object.defineProperty(t,a,o),o};let z=class{constructor(e,t){this.w=e,this.baseUrl=t,i(this)}async load(e){const t=await fetch(e),a=await t.arrayBuffer(),s=await this.audioContext.decodeAudioData(a),i=this.audioContext.createBufferSource();return i.buffer=s,i.connect(this.audioContext.destination),i}async play(e){this.audioContext=this.audioContext||new(AudioContext||this.w.webkitAudioContext);(await this.load(`${this.baseUrl}/${e.audio}`)).start()}open(e,t){new Notification(t,{body:e.text,icon:`${this.baseUrl}/assets/timer.png`})}show(e,t){"Notification"in this.w&&"denied"!==Notification.permission&&("granted"===Notification.permission?this.open(e,t):Notification.requestPermission((a=>{"granted"===a&&this.open(e,t)})))}};z=H([s],z);var W=z,K=function(e,t,a,s){var i,r=arguments.length,o=r<3?t:null===s?s=Object.getOwnPropertyDescriptor(t,a):s;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)o=Reflect.decorate(e,t,a,s);else for(var n=e.length-1;n>=0;n--)(i=e[n])&&(o=(r<3?i(o):r>3?i(t,a,o):i(t,a))||o);return r>3&&o&&Object.defineProperty(t,a,o),o};let G=class{constructor(e,t,a){this.init=e=>{this.p=e},this.getElapsedNotification=()=>({audio:"assets/looking_down.mp3",text:this.p.localizeKey("elapsedNotification")}),this.isOngoingOrPausedForAnotherCard=async e=>{const t=await this.boardStorage.read(e,l.DISCUSSION_STATUS),a=await this.boardStorage.read(e,l.DISCUSSION_CARD_ID);return["ONGOING","PAUSED"].includes(t)&&a!==e.getContext().card},this.hasEverBeenDiscussed=async e=>void 0!==await this.cardStorage.read(e,h.DISCUSSION_STATUS),this.hasNotBeenArchived=async(e,t)=>!!(await e.cards("id","name")).find((e=>e.id===t)),this.isOngoingFor=async e=>"ONGOING"===await this.cardStorage.read(e,h.DISCUSSION_STATUS),this.isPausedFor=async e=>"PAUSED"===await this.cardStorage.read(e,h.DISCUSSION_STATUS),this.getElapsed=e=>this.cardStorage.read(e,h.DISCUSSION_ELAPSED),this.updateElapsed=async e=>{const t=await this.boardStorage.read(e,l.DISCUSSION_STARTED_AT),a=Date.now()-t;await this.saveElapsed(e),a>this.maxDiscussionDuration&&(await this.pause(e,!0),await w.event(this.w,"discussionStatusChanged",{newStatus:"ended"}))},this.saveElapsed=async e=>{const t=await this.boardStorage.read(e,l.DISCUSSION_CARD_ID),a=await this.boardStorage.read(e,l.DISCUSSION_STARTED_AT),s=await this.boardStorage.read(e,l.DISCUSSION_PREVIOUS_ELAPSED)||0,i=a?Date.now()-a:0;await this.cardStorage.write(e,h.DISCUSSION_ELAPSED,i+s,t)},this.start=async e=>{await this.boardStorage.writeMultiple(e,{[l.DISCUSSION_STATUS]:"ONGOING",[l.DISCUSSION_CARD_ID]:e.getContext().card,[l.DISCUSSION_STARTED_AT]:Date.now(),[l.DISCUSSION_PREVIOUS_ELAPSED]:await this.getElapsed(e),[l.DISCUSSION_INTERVAL_ID]:setInterval(this.updateElapsed,5e3,e)}),await this.cardStorage.write(e,h.DISCUSSION_STATUS,"ONGOING"),await this.cardStorage.delete(e,h.DISCUSSION_THUMBS)},this.pause=async(e,t=!1)=>{const a=await this.boardStorage.read(e,l.DISCUSSION_INTERVAL_ID),s=await this.boardStorage.read(e,l.DISCUSSION_CARD_ID),i=(await e.cards("id","name")).find((e=>e.id===s)).name;if(clearInterval(a),await this.cardStorage.write(e,h.DISCUSSION_STATUS,"PAUSED"),await this.saveElapsed(e),await this.boardStorage.writeMultiple(e,{[l.DISCUSSION_STATUS]:"PAUSED",[l.DISCUSSION_STARTED_AT]:null,[l.DISCUSSION_PREVIOUS_ELAPSED]:await this.getElapsed(e),[l.DISCUSSION_INTERVAL_ID]:null}),t){const e=this.getElapsedNotification();await this.notifications.play(e),this.notifications.show(e,i)}},this.end=async e=>{const t=await this.boardStorage.read(e,l.DISCUSSION_INTERVAL_ID),a=await this.boardStorage.read(e,l.DISCUSSION_CARD_ID);clearInterval(t),await this.cardStorage.write(e,h.DISCUSSION_STATUS,"ENDED",a),await this.saveElapsed(e),await this.cardStorage.deleteMultiple(e,[h.DISCUSSION_THUMBS],a),await this.boardStorage.deleteMultiple(e,[l.DISCUSSION_STATUS,l.DISCUSSION_CARD_ID,l.DISCUSSION_STARTED_AT,l.DISCUSSION_PREVIOUS_ELAPSED,l.DISCUSSION_INTERVAL_ID])},this.reset=async e=>{await this.hasEverBeenDiscussed(e)&&await this.cardStorage.deleteMultiple(e,[h.DISCUSSION_STATUS,h.DISCUSSION_ELAPSED,h.DISCUSSION_THUMBS],e.getContext().card)},this.w=e,this.baseUrl=t,this.notifications=new W(this.w,this.baseUrl),this.maxDiscussionDuration=a,this.boardStorage=new l,this.cardStorage=new h,i(this)}};G=K([s],G);var F=G;async function q(e){const t=(new TextEncoder).encode(e),a=await window.crypto.subtle.digest("SHA-256",t);return Array.from(new Uint8Array(a)).map((e=>e.toString(16).padStart(2,"0"))).join("")}const Z=e=>Object.prototype.toString.call(e).slice(8,-1),X=e=>"string"==typeof e||e instanceof String,J="0|[1-9]\\d*",Q="\\d*[A-Z-][A-Z\\d-]*",Y=`(?:${Q}|${J})`,ee=`(?:${Q}|\\d+)`,te=`((?:${J})(?:\\.(?:${J})){2})(?:-(${`${Y}(?:\\.${Y})*`}))?(?:\\+(${`${ee}(?:\\.${ee})*`}))?`,ae=new RegExp(`^(?:${J})$`),se=new RegExp(`^v?${te}$`,"i"),ie=new RegExp(`^${te}$`,"i"),re=(e,t=!1)=>{if(!X(e))throw new TypeError(`Expected String but got ${Z(e)}.`);return(t?ie:se).test(e)},oe=(e,t=!1)=>{if(!X(e))throw new TypeError(`Expected String but got ${Z(e)}.`);if(!t&&!ae.test(e))throw new Error(`${e} is not a stringified positive integer.`);let a;if(ae.test(e)){if(a=parseInt(e,10),!Number.isSafeInteger(a))throw new RangeError(`${a} exceeds ${Number.MAX_SAFE_INTEGER}.`)}else a=e;return a},ne=(e,t=!1)=>{if(!X(e))throw new TypeError(`Expected String but got ${Z(e)}.`);const a=re(e,!!t);let s,i,r,o,n;if(a){const a=t?ie:se,[,c,d,l]=e.match(a);[s,i,r]=c.split(".").map((e=>oe(e))),d&&(o=d.split(".").map((e=>oe(e,!0)))),l&&(n=l.split(".").map((e=>oe(e,!0))))}return{version:e,matches:a,major:s,minor:i,patch:r,pre:o,build:n}};var ce=function(e,t,a,s){var i,r=arguments.length,o=r<3?t:null===s?s=Object.getOwnPropertyDescriptor(t,a):s;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)o=Reflect.decorate(e,t,a,s);else for(var n=e.length-1;n>=0;n--)(i=e[n])&&(o=(r<3?i(o):r>3?i(t,a,o):i(t,a))||o);return r>3&&o&&Object.defineProperty(t,a,o),o};let de=class{constructor(e,t){this.boardStorage=e,this.memberStorage=t,i(this)}async isThereANewMinorOrMajor(e){const t=await this.memberStorage.read(e,A.POWER_UP_VERSION);if(!t)return!0;const a=ne(t),s=ne("0.9.8"),i=s.major>a.major||s.minor>a.minor;return!a||i}async showMenu(t){const a=await this.memberStorage.read(t,A.POWER_UP_VERSION),s=a?t.localizeKey("boardButtonPopupTitle",{oldVersion:a,newVersion:"0.9.8"}):t.localizeKey("boardButtonPopupTitleMissingVersion",{newVersion:"0.9.8"});return t.popup({title:s,url:`./release-notes.html?${await w.getOverrides(this.boardStorage,t)}&${await e(this.boardStorage,t)}`,args:{version:"0.9.8",localization:v},callback:this.storeNewVersion,height:65})}async storeNewVersion(e){await this.memberStorage.write(e,A.POWER_UP_VERSION,"0.9.8")}};de=ce([s],de);var le=de,ue=function(e,t,a,s){var i,r=arguments.length,o=r<3?t:null===s?s=Object.getOwnPropertyDescriptor(t,a):s;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)o=Reflect.decorate(e,t,a,s);else for(var n=e.length-1;n>=0;n--)(i=e[n])&&(o=(r<3?i(o):r>3?i(t,a,o):i(t,a))||o);return r>3&&o&&Object.defineProperty(t,a,o),o};let he=class{constructor(){this.cardStorage=new h,i(this)}async hasCurrentMemberVoted(e){const t=await this.cardStorage.read(e,h.VOTES);if(!t)return!1;return!!t[e.getContext().member]}async getVotes(e){return await this.cardStorage.read(e,h.VOTES)}async countVotesByCard(e,t){const a=await this.cardStorage.read(e,h.VOTES,t);return a?Object.keys(a).filter((e=>a[e])).length:0}async getMaxVotes(e){const t=await e.list("cards");return Math.ceil(t.cards.length/3)}async canCurrentMemberVote(e){if(await this.hasCurrentMemberVoted(e))return!0;const t=(await e.list("cards")).cards.map((e=>e.id));return await this.countVotesByMember(e,t)<await this.getMaxVotes(e)}async countVotesByMember(e,t){return(await Promise.all(t.map((async t=>{const a=await this.cardStorage.read(e,h.VOTES,t);if(!a)return 0;return a[e.getContext().member]?1:0})))).reduce(((e,t)=>e+t),0)}};he=ue([s],he);var Se=he;var we=class extends N{constructor({w:e,config:t}){super({w:e,config:t}),this.t=e.TrelloPowerUp;const{hostname:a,port:s,defaultDuration:i}=this.config.production;this.baseUrl=`${a}${s?`:${s}`:""}`,this.discussion=new F(this.w,this.baseUrl,i),this.voting=new Se,this.versionChecker=new le(this.boardStorage,this.memberStorage),this.elapsedCardBadge=new $(this.discussion),this.elapsedCardDetailBadge=new x(this.discussion),this.votingCardBadge=new k(this.w,this.baseUrl,this.voting,this.boardStorage,this.cardStorage),this.votingCardDetailBadge=new j(this.w,this.baseUrl,this.voting,this.boardStorage,this.cardStorage),this.capabilityHandlers=new C(this)}async handleVoting(t){if(!await this.voting.canCurrentMemberVote(t))return t.popup({title:"Leaner Coffee",url:`${this.baseUrl}/too_many_votes.html?${await w.getOverrides(this.boardStorage,t)}&${await e(this.boardStorage,t)}`,args:{maxVotes:await this.voting.getMaxVotes(t),localization:v},height:98});const a=await this.voting.getVotes(t)||{},s=await t.member("id","username","fullName","avatar");let i;a[s.id]?(delete a[s.id],i="removed"):(a[s.id]={username:s.username,fullName:s.fullName,avatar:s.avatar},i="added"),await this.cardStorage.write(t,h.VOTES,a),await w.event(this.w,"voted",{outcome:i})}async stopAndStart(e){await w.event(this.w,"discussionStatusOverridden"),await this.discussion.end(e),await w.event(this.w,"discussionStatusChanged",{newStatus:"stopped"}),await this.discussion.start(e),await w.event(this.w,"discussionStatusChanged",{newStatus:"started"})}async handleDiscussion(e){if(await this.discussion.isOngoingOrPausedForAnotherCard(e)){const t=await this.boardStorage.read(e,l.DISCUSSION_STATUS),a=await this.boardStorage.read(e,l.DISCUSSION_CARD_ID);if(await this.discussion.hasNotBeenArchived(e,a)){const s=(await e.cards("id","name")).find((e=>e.id===a));return e.popup({callback:this.stopAndStart,title:"Leaner Coffee",url:`${this.baseUrl}/ongoing_or_paused.html?${await w.getOverrides(this.boardStorage,e)}`,args:{currentCardBeingDiscussed:s.name,currentDiscussionStatus:t,localization:v},height:120})}console.warn(`Card with id ${a} not found in current board, most likely archived. Cleaning up.`),await w.event(this.w,"discussionMenuOpened",{status:"ongoing other"}),await this.boardStorage.deleteMultiple(e,[l.DISCUSSION_STATUS,l.DISCUSSION_CARD_ID,l.DISCUSSION_STARTED_AT,l.DISCUSSION_PREVIOUS_ELAPSED,l.DISCUSSION_INTERVAL_ID])}let t,a=[];switch(!0){case await this.discussion.isOngoingFor(e):a=[{text:e.localizeKey("pauseTimer",{symbol:"❙ ❙"}),callback:async e=>{await w.event(this.w,"discussionStatusChanged",{newStatus:"paused"}),await this.discussion.pause(e),await e.closePopup(),await this.discussion.cardStorage.write(e,h.DISCUSSION_BUTTON_LABEL,e.localizeKey("pausingTimer",{symbol:"❙ ❙"}))}},{text:e.localizeKey("endDiscussion",{symbol:"■"}),callback:async e=>{await w.event(this.w,"discussionStatusChanged",{newStatus:"stopped"}),await this.discussion.end(e),await e.closePopup(),await this.discussion.cardStorage.write(e,h.DISCUSSION_BUTTON_LABEL,e.localizeKey("endingDiscussion",{symbol:"■"}))}}],t="ongoing";break;case await this.discussion.isPausedFor(e):a=[{text:e.localizeKey("resumeDiscussion",{symbol:"▶"}),callback:async e=>{await w.event(this.w,"discussionStatusChanged",{newStatus:"resumed"}),await this.discussion.start(e),await e.closePopup(),await this.discussion.cardStorage.write(e,h.DISCUSSION_BUTTON_LABEL,e.localizeKey("resumingDiscussion",{symbol:"▶"}))}},{text:e.localizeKey("endDiscussion",{symbol:"■"}),callback:async e=>{await w.event(this.w,"discussionStatusChanged",{newStatus:"stopped"}),await this.discussion.end(e),await e.closePopup(),await this.discussion.cardStorage.write(e,h.DISCUSSION_BUTTON_LABEL,e.localizeKey("endingDiscussion",{symbol:"■"}))}}],t="paused";break;default:a=[{text:e.localizeKey("startTimer",{symbol:"▶"}),callback:async e=>{await w.event(this.w,"discussionStatusChanged",{newStatus:"started"}),await this.discussion.start(e),await e.closePopup(),await this.discussion.cardStorage.write(e,h.DISCUSSION_BUTTON_LABEL,e.localizeKey("startingTimer",{symbol:"▶"}))}}],await this.discussion.hasEverBeenDiscussed(e)?(a.push({text:e.localizeKey("resetDiscussion",{symbol:"↺"}),callback:async e=>{await w.event(this.w,"discussionStatusChanged",{newStatus:"reset"}),await this.discussion.reset(e),await e.closePopup(),await this.discussion.cardStorage.write(e,h.DISCUSSION_BUTTON_LABEL,e.localizeKey("resettingDiscussion",{symbol:"↺"}))}}),t="discussed before"):t="never discussed"}return await w.event(this.w,"discussionMenuOpened",{status:t}),e.popup({title:"Leaner Coffee",items:a})}async getButtonLabel(e){let t=await this.discussion.cardStorage.read(e,h.DISCUSSION_BUTTON_LABEL);return t&&setTimeout((()=>{this.discussion.cardStorage.write(e,h.DISCUSSION_BUTTON_LABEL,null)}),2e3),t=t||e.localizeKey("discussion"),t}async handlePowerupEnabled(e){const t=await e.organization("id"),a=await e.board("id"),s=await q(t.id),i=await q(a.id);await this.boardStorage.writeMultiple(e,{[l.POWER_UP_INSTALLATION_DATE]:(new Date).toISOString(),[l.ORGANISATION_HASH]:s,[l.BOARD_HASH]:i})}async start(){const e=this.t.initialize(this.capabilityHandlers.getAll(),{localization:v,helpfulStacks:!1});this.discussion.init(e),await navigator.locks.request("powerup_init",{ifAvailable:!0},(async t=>{null!==t&&(await this.boardStorage.read(e,l.POWER_UP_INSTALLATION_DATE)||await this.handlePowerupEnabled(e))}));const t=await this.boardStorage.read(e,l.ORGANISATION_HASH),a=await this.boardStorage.read(e,l.BOARD_HASH);window.Sentry&&window.Sentry.onLoad((async()=>{window.Sentry.setTags({organisationIdHash:t,boardIdHash:a})})),this.w.LeanerCoffeeAnalyticsReferrer="https://"+t,this.w.LeanerCoffeeAnalyticsHostname=a,this.w.LeanerCoffeeAnalyticsBeforeSend=w.beforeSend,window.setTimeout((async()=>{await w.pageview(this.w)}),0)}};new we({w:window,config:{production:{hostname:"https://leaner-coffee.tatablack.net",defaultDuration:3e5,supportedLocales:["en","it"]}}}).start()}()}();
//# sourceMappingURL=index.a4ab7582d020b93ad6e3.js.map