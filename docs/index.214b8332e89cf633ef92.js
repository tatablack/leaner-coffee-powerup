try{let t="undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof globalThis?globalThis:"undefined"!=typeof self?self:{},e=(new t.Error).stack;e&&(t._sentryDebugIds=t._sentryDebugIds||{},t._sentryDebugIds[e]="3bd6b9db-a04b-4502-9a93-35d7592ee94b",t._sentryDebugIdIdentifier="sentry-dbid-3bd6b9db-a04b-4502-9a93-35d7592ee94b")}catch(t){}!function(){var t={262:function(t){function e(t,e){e=e||2;let s=t.toString(),a=0;return a=e-s.length+1,s=new Array(a).join("0").concat(s),s}t.exports=function(t,s){const a=s&&s.leading,i=s&&s.ms,r=t<0?-t:t,o=function(t,e){return e?t<0?"-":"":t<=-1e3?"-":""}(t,i),n=function(t){if("number"!=typeof t)throw new TypeError("Expected a number");return{days:Math.trunc(t/864e5),hours:Math.trunc(t/36e5)%24,minutes:Math.trunc(t/6e4)%60,seconds:Math.trunc(t/1e3)%60,ms:Math.trunc(t)%1e3}}(r),c=e(n.seconds);let d="";return n.days&&!d&&(d=o+n.days+":"+e(n.hours)+":"+e(n.minutes)+":"+c),n.hours&&!d&&(d=o+(a?e(n.hours):n.hours)+":"+e(n.minutes)+":"+c),d||(d=o+(a?e(n.minutes):n.minutes)+":"+c),i&&(d+="."+e(n.ms,3)),d}}},e={};function s(a){var i=e[a];if(void 0!==i)return i.exports;var r=e[a]={exports:{}};return t[a](r,r.exports,s),r.exports}s.n=function(t){var e=t&&t.__esModule?function(){return t.default}:function(){return t};return s.d(e,{a:e}),e},s.d=function(t,e){for(var a in e)s.o(e,a)&&!s.o(t,a)&&Object.defineProperty(t,a,{enumerable:!0,get:e[a]})},s.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},function(){"use strict";const t=async(t,e)=>`organisationIdHash=${await t.getOrganisationIdHash(e)}&boardIdHash=${await t.getBoardIdHash(e)}`,e=(t,e,s)=>{const a=s.value,i="AsyncFunction"===a.constructor.name,r=`Leaner Coffee Power-Up: error in ${e} (reported)`;return s.value=i?async function(...t){try{return await a.apply(this,t)}catch(t){console.warn(r),window.Sentry.captureException(t)}}:function(...t){try{return a.apply(this,t)}catch(t){console.warn(r),window.Sentry.captureException(t)}},s};function a(t){const s=t.prototype;return Object.getOwnPropertyNames(s).filter((t=>"function"==typeof s[t]&&"constructor"!==t)).forEach((t=>{const a=Object.getOwnPropertyDescriptor(s,t);if(a&&"function"==typeof a.value){const i=e(0,t,a);Object.defineProperty(s,t,i)}})),t}const i=t=>{const e=t.constructor.prototype;Object.getOwnPropertyNames(e).filter((t=>"function"==typeof e[t]&&"constructor"!==t)).forEach((s=>e[s]=e[s].bind(t)))};var r=function(t,e,s,a){var i,r=arguments.length,o=r<3?e:null===a?a=Object.getOwnPropertyDescriptor(e,s):a;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)o=Reflect.decorate(t,e,s,a);else for(var n=t.length-1;n>=0;n--)(i=t[n])&&(o=(r<3?i(o):r>3?i(e,s,o):i(e,s))||o);return r>3&&o&&Object.defineProperty(e,s,o),o};let o=class{constructor(t="member",e="private"){Object.assign(this,{scope:t,visibility:e}),i(this)}read(t,e,s){return t.get(s??this.scope,this.visibility,e)}write(t,e,s,a){return t.set(a??this.scope,this.visibility,e,s)}writeMultiple(t,e,s){return t.set(s??this.scope,this.visibility,e)}delete(t,e,s){return t.remove(s??this.scope,this.visibility,e)}deleteMultiple(t,e,s){return t.remove(s??this.scope,this.visibility,e)}};o=r([a],o);var n=o;class c extends n{constructor(){super("card","shared")}getDiscussionStatus(t){return super.read(t,c.DISCUSSION_STATUS)}getDiscussionElapsed(t){return super.read(t,c.DISCUSSION_ELAPSED)}getDiscussionThumbs(t){return super.read(t,c.DISCUSSION_THUMBS)}getDiscussionButtonLabel(t){return super.read(t,c.DISCUSSION_BUTTON_LABEL)}saveDiscussionStatus(t,e,s){return super.write(t,c.DISCUSSION_STATUS,e,s)}saveDiscussionElapsed(t,e,s){return super.write(t,c.DISCUSSION_ELAPSED,e,s)}saveDiscussionThumbs(t,e){return super.write(t,c.DISCUSSION_THUMBS,e)}saveVotes(t,e){return super.write(t,c.VOTES,e)}deleteVotes(t){return super.delete(t,c.VOTES)}saveDiscussionButtonLabel(t,e){return super.write(t,c.DISCUSSION_BUTTON_LABEL,e)}deleteDiscussionThumbs(t){return super.delete(t,c.DISCUSSION_THUMBS)}}c.DISCUSSION_STATUS="leancoffeeDiscussionStatus",c.DISCUSSION_ELAPSED="leancoffeeDiscussionElapsed",c.DISCUSSION_THUMBS="leancoffeeDiscussionThumbs",c.VOTES="leancoffeeVotes",c.DISCUSSION_BUTTON_LABEL="discussionButtonLabel";var d=c;const u=t=>{const e=new URL(t);return e.protocol+e.hostname+(e.port?`:${e.port}`:"")+e.pathname};var l={beforeSend:(t,e)=>({...e,referrer:window.LeanerCoffeeAnalyticsReferrer,hostname:window.LeanerCoffeeAnalyticsHostname,url:u(e.url)}),pageview:async(t,e={})=>{t.umami?await t.umami.track((t=>({...t,...e}))):console.warn("Umami not available for pageview",e)},event:async(t,e,s)=>{t.umami?await t.umami.track(e,s):console.warn("Umami not available for event "+e,s)},getOverrides:async(t,e)=>{const s=await t.getOrganisationIdHash(e),a=await t.getBoardIdHash(e);return`referrer=${encodeURIComponent("https://"+s)}&hostname=${a}`}};const{supportedLocales:h}={hostname:"https://leaner-coffee.tatablack.net",defaultDuration:3e5,supportedLocales:["en","it"]},w={defaultLocale:"en",supportedLocales:h,resourceUrl:"/i18n/{locale}.json"};var S=function(t,e,s,a){var i,r=arguments.length,o=r<3?e:null===a?a=Object.getOwnPropertyDescriptor(e,s):a;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)o=Reflect.decorate(t,e,s,a);else for(var n=t.length-1;n>=0;n--)(i=t[n])&&(o=(r<3?i(o):r>3?i(e,s,o):i(e,s))||o);return r>3&&o&&Object.defineProperty(e,s,o),o};let p=class{constructor(t){this.powerUp=t,i(this)}async boardButtonsHandler(t){return await this.powerUp.versionChecker.isThereANewMinorOrMajor(t)?[{icon:{dark:`${this.powerUp.baseUrl}/assets/moka_white.svg`,light:`${this.powerUp.baseUrl}/assets/moka.svg`},text:t.localizeKey("boardButtonLabel"),callback:this.powerUp.versionChecker.showMenu}]:[]}async cardBackSection(t){return void 0===await this.powerUp.discussion.cardStorage.getDiscussionStatus(t)?null:{title:t.localizeKey("discussion"),icon:`${this.powerUp.baseUrl}/assets/powerup/timer.svg`,content:{type:"iframe",url:t.signUrl(`${this.powerUp.baseUrl}/discussion-ui.html?${await l.getOverrides(this.powerUp.boardStorage,t)}`)}}}async cardBadges(t){return[await this.powerUp.elapsedCardBadge.render(t),await this.powerUp.votingCardBadge.render(t)].filter((t=>t))}async cardButtons(t){return[{icon:`${this.powerUp.baseUrl}/assets/powerup/timer.svg`,text:await this.powerUp.getButtonLabel(t),callback:this.powerUp.handleDiscussion},{icon:`${this.powerUp.baseUrl}/assets/powerup/heart.svg`,text:t.localizeKey("vote",{symbol:await this.powerUp.voting.hasCurrentMemberVoted(t)?"☑":"☐"}),callback:this.powerUp.handleVoting}]}async cardDetailBadges(t){return[await this.powerUp.elapsedCardDetailBadge.render(t),await this.powerUp.votingCardDetailBadge.render(t)].filter((t=>t))}async listActions(t){return Promise.resolve([{text:t.localizeKey("clearVotesFromList"),callback:async t=>{(await t.list("cards")).cards.forEach((({id:e})=>{this.powerUp.cardStorage.deleteMultiple(t,[d.VOTES],e)})),await l.event(window,"listVotesCleared")}}])}async listSorters(t){return Promise.resolve([{text:t.localizeKey("sortByVote"),callback:async(t,e)=>{const s=(await Promise.all(e.cards.map((async e=>({leanCoffeeVotes:await this.powerUp.voting.countVotesByCard(t,e.id),id:e.id}))))).sort(((t,e)=>t.leanCoffeeVotes<e.leanCoffeeVotes?1:e.leanCoffeeVotes<t.leanCoffeeVotes?-1:0));return await l.event(window,"listVotesSorted"),{sortedIds:s.map((t=>t.id))}}}])}async onEnable(t){await navigator.locks.request("powerup_init",{ifAvailable:!0},(async e=>{const s=await this.powerUp.boardStorage.getInitialised(t);null===e||s||s||await this.powerUp.handlePowerupEnabled(t)})),await l.event(window,"enabled")}async onDisable(){await l.event(window,"disabled")}async showSettings(t){return t.popup({title:"Leaner Coffee 0.9.3",url:`${this.powerUp.baseUrl}/settings.html?${await l.getOverrides(this.powerUp.boardStorage,t)}`,height:184,args:{localization:w}})}getAll(){return{"board-buttons":this.boardButtonsHandler,"card-back-section":this.cardBackSection,"card-badges":this.cardBadges,"card-buttons":this.cardButtons,"card-detail-badges":this.cardDetailBadges,"list-actions":this.listActions,"list-sorters":this.listSorters,"on-enable":this.onEnable,"on-disable":this.onDisable,"show-settings":this.showSettings}}};p=S([a],p);var g=p;class f extends n{constructor(){super("board","shared")}async getDiscussionStatus(t){return super.read(t,f.DISCUSSION_STATUS)}async getDiscussionCardId(t){return super.read(t,f.DISCUSSION_CARD_ID)}async getDiscussionStartedAt(t){return super.read(t,f.DISCUSSION_STARTED_AT)}async getDiscussionPreviousElapsed(t){return super.read(t,f.DISCUSSION_PREVIOUS_ELAPSED)}async getDiscussionIntervalId(t){return super.read(t,f.DISCUSSION_INTERVAL_ID)}async getPowerUpInstallationDate(t){return super.read(t,f.POWER_UP_INSTALLATION_DATE)}async getOrganisationIdHash(t){return super.read(t,f.ORGANISATION_HASH)}async setOrganisationIdHash(t,e){return super.write(t,f.ORGANISATION_HASH,e)}async getBoardIdHash(t){return super.read(t,f.BOARD_HASH)}async setBoardIdHash(t,e){return super.write(t,f.BOARD_HASH,e)}async getInitialised(t){return!!await super.read(t,f.POWER_UP_INSTALLATION_DATE)}setPowerUpInstallationDate(t,e){return super.write(t,f.POWER_UP_INSTALLATION_DATE,e)}}f.DISCUSSION_STATUS="leancoffeeDiscussionStatus",f.DISCUSSION_CARD_ID="leancoffeeDiscussionCardId",f.DISCUSSION_STARTED_AT="leancoffeeDiscussionStartedAt",f.DISCUSSION_PREVIOUS_ELAPSED="leancoffeeDiscussionPreviousElapsed",f.DISCUSSION_INTERVAL_ID="leancoffeeDiscussionIntervalId",f.POWER_UP_INSTALLATION_DATE="powerUpInstallationDate",f.ORGANISATION_HASH="organisationHash",f.BOARD_HASH="boardHash";var b=f;class y extends n{constructor(){super("member","private")}}y.POWER_UP_VERSION="powerUpVersion";var D=y,I=function(t,e,s,a){var i,r=arguments.length,o=r<3?e:null===a?a=Object.getOwnPropertyDescriptor(e,s):a;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)o=Reflect.decorate(t,e,s,a);else for(var n=t.length-1;n>=0;n--)(i=t[n])&&(o=(r<3?i(o):r>3?i(e,s,o):i(e,s))||o);return r>3&&o&&Object.defineProperty(e,s,o),o};let v=class{constructor({w:t,config:e}){this.w=t,this.config=e,this.boardStorage=new b,this.cardStorage=new d,this.memberStorage=new D,i(this)}};v=I([a],v);var O=s(262),m=s.n(O),U=function(t,e,s,a){var i,r=arguments.length,o=r<3?e:null===a?a=Object.getOwnPropertyDescriptor(e,s):a;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)o=Reflect.decorate(t,e,s,a);else for(var n=t.length-1;n>=0;n--)(i=t[n])&&(o=(r<3?i(o):r>3?i(e,s,o):i(e,s))||o);return r>3&&o&&Object.defineProperty(e,s,o),o};let E=class{constructor(t){this.getText=async(t,e)=>m()(e),this.getColor=async t=>await this.discussion.isOngoingFor(t)?"orange":await this.discussion.isPausedFor(t)?"yellow":"light-gray",this.discussion=t,this.render=this.render.bind(this),i(this)}async render(t){const e=await this.discussion.getElapsed(t);return e?{text:await this.getText(t,e),color:await this.getColor(t)}:null}};E=U([a],E);var C=E;var A=class extends C{constructor(){super(...arguments),this.render=async t=>{if("ENDED"!==await this.discussion.cardStorage.getDiscussionStatus(t))return null;const e=await super.render(t);return e.title=t.localizeKey("discussionDurationTitle"),e}}},_=function(t,e,s,a){var i,r=arguments.length,o=r<3?e:null===a?a=Object.getOwnPropertyDescriptor(e,s):a;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)o=Reflect.decorate(t,e,s,a);else for(var n=t.length-1;n>=0;n--)(i=t[n])&&(o=(r<3?i(o):r>3?i(e,s,o):i(e,s))||o);return r>3&&o&&Object.defineProperty(e,s,o),o};let T=class{constructor(t,e,s,a,r){this.getVoters=async t=>{const e=await this.voting.getVotes(t)||{};return Object.values(e).reduce(((t,e)=>(e.username&&t.push({text:`${e.fullName} (${e.username})`,avatar:e.avatar}),t)),[])},this.w=t,this.baseUrl=e,this.voting=s,this.boardStorage=a,this.cardStorage=r,this.render=this.render.bind(this),i(this)}async render(t){const e=await this.getVoters(t);if(!e.length)return null;const s=await this.voting.hasCurrentMemberVoted(t);return{text:e.length.toString(),color:s?"blue":null,icon:`${this.baseUrl}/assets/powerup/${s?"heart_white.svg":"heart.svg"}`}}};T=_([a],T);var N=T;var P=class extends N{constructor(){super(...arguments),this.clearVoters=async t=>{const e=await this.getVoters(t);await this.cardStorage.deleteVotes(t),await l.event(this.w,"votesCleared",{total:e.length})},this.showVoters=async e=>{const s=await this.getVoters(e);s.length&&await e.popup({title:e.localizeKey("voters"),url:`./voters.html?${await l.getOverrides(this.boardStorage,e)}&${await t(this.boardStorage,e)}`,args:{items:s,localization:w},callback:this.clearVoters})},this.render=async t=>{const e=await super.render(t);return e&&(e.title=t.localizeKey("voters"),delete e.icon,e.callback=this.showVoters),e}}},R=function(t,e,s,a){var i,r=arguments.length,o=r<3?e:null===a?a=Object.getOwnPropertyDescriptor(e,s):a;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)o=Reflect.decorate(t,e,s,a);else for(var n=t.length-1;n>=0;n--)(i=t[n])&&(o=(r<3?i(o):r>3?i(e,s,o):i(e,s))||o);return r>3&&o&&Object.defineProperty(e,s,o),o};let V=class{constructor(t,e){this.w=t,this.baseUrl=e,i(this)}async load(t){const e=await fetch(t),s=await e.arrayBuffer(),a=await this.audioContext.decodeAudioData(s),i=this.audioContext.createBufferSource();return i.buffer=a,i.connect(this.audioContext.destination),i}async play(t){this.audioContext=this.audioContext||new(AudioContext||this.w.webkitAudioContext);(await this.load(`${this.baseUrl}/${t.audio}`)).start()}open(t,e){new Notification(e,{body:t.text,icon:`${this.baseUrl}/assets/timer.png`})}show(t,e){"Notification"in this.w&&"denied"!==Notification.permission&&("granted"===Notification.permission?this.open(t,e):Notification.requestPermission((s=>{"granted"===s&&this.open(t,e)})))}};V=R([a],V);var B=V,L=function(t,e,s,a){var i,r=arguments.length,o=r<3?e:null===a?a=Object.getOwnPropertyDescriptor(e,s):a;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)o=Reflect.decorate(t,e,s,a);else for(var n=t.length-1;n>=0;n--)(i=t[n])&&(o=(r<3?i(o):r>3?i(e,s,o):i(e,s))||o);return r>3&&o&&Object.defineProperty(e,s,o),o};let x=class{constructor(t,e,s){this.init=t=>{this.p=t},this.getElapsedNotification=()=>({audio:"assets/looking_down.mp3",text:this.p.localizeKey("elapsedNotification")}),this.isOngoingOrPausedForAnotherCard=async t=>{const e=await this.boardStorage.getDiscussionStatus(t),s=await this.boardStorage.getDiscussionCardId(t);return["ONGOING","PAUSED"].includes(e)&&s!==t.getContext().card},this.hasEverBeenDiscussed=async t=>void 0!==await this.cardStorage.getDiscussionStatus(t),this.hasNotBeenArchived=async(t,e)=>!!(await t.cards("id","name")).find((t=>t.id===e)),this.isOngoingFor=async t=>"ONGOING"===await this.cardStorage.getDiscussionStatus(t),this.isPausedFor=async t=>"PAUSED"===await this.cardStorage.getDiscussionStatus(t),this.getElapsed=t=>this.cardStorage.getDiscussionElapsed(t),this.updateElapsed=async t=>{const e=await this.boardStorage.getDiscussionStartedAt(t),s=Date.now()-e;await this.saveElapsed(t),s>this.maxDiscussionDuration&&(await this.pause(t,!0),await l.event(this.w,"discussionStatusChanged",{newStatus:"ended"}))},this.saveElapsed=async t=>{const e=await this.boardStorage.getDiscussionCardId(t),s=await this.boardStorage.getDiscussionStartedAt(t),a=await this.boardStorage.getDiscussionPreviousElapsed(t)||0,i=s?Date.now()-s:0;await this.cardStorage.saveDiscussionElapsed(t,i+a,e)},this.start=async t=>{await this.boardStorage.writeMultiple(t,{[b.DISCUSSION_STATUS]:"ONGOING",[b.DISCUSSION_CARD_ID]:t.getContext().card,[b.DISCUSSION_STARTED_AT]:Date.now(),[b.DISCUSSION_PREVIOUS_ELAPSED]:await this.getElapsed(t),[b.DISCUSSION_INTERVAL_ID]:setInterval(this.updateElapsed,5e3,t)}),await this.cardStorage.saveDiscussionStatus(t,"ONGOING"),await this.cardStorage.deleteDiscussionThumbs(t)},this.pause=async(t,e=!1)=>{const s=await this.boardStorage.getDiscussionIntervalId(t),a=await this.boardStorage.getDiscussionCardId(t),i=(await t.cards("id","name")).find((t=>t.id===a)).name;if(clearInterval(s),await this.cardStorage.saveDiscussionStatus(t,"PAUSED"),await this.saveElapsed(t),await this.boardStorage.writeMultiple(t,{[b.DISCUSSION_STATUS]:"PAUSED",[b.DISCUSSION_STARTED_AT]:null,[b.DISCUSSION_PREVIOUS_ELAPSED]:await this.getElapsed(t),[b.DISCUSSION_INTERVAL_ID]:null}),e){const t=this.getElapsedNotification();await this.notifications.play(t),this.notifications.show(t,i)}},this.end=async t=>{const e=await this.boardStorage.getDiscussionIntervalId(t),s=await this.boardStorage.getDiscussionCardId(t);clearInterval(e),await this.cardStorage.saveDiscussionStatus(t,"ENDED",s),await this.saveElapsed(t),await this.cardStorage.deleteMultiple(t,[d.DISCUSSION_THUMBS],s),await this.boardStorage.deleteMultiple(t,[b.DISCUSSION_STATUS,b.DISCUSSION_CARD_ID,b.DISCUSSION_STARTED_AT,b.DISCUSSION_PREVIOUS_ELAPSED,b.DISCUSSION_INTERVAL_ID])},this.reset=async t=>{await this.hasEverBeenDiscussed(t)&&await this.cardStorage.deleteMultiple(t,[d.DISCUSSION_STATUS,d.DISCUSSION_ELAPSED,d.DISCUSSION_THUMBS],t.getContext().card)},this.w=t,this.baseUrl=e,this.notifications=new B(this.w,this.baseUrl),this.maxDiscussionDuration=s,this.boardStorage=new b,this.cardStorage=new d,i(this)}};x=L([a],x);var $=x;async function j(t){const e=(new TextEncoder).encode(t),s=await window.crypto.subtle.digest("SHA-256",e);return Array.from(new Uint8Array(s)).map((t=>t.toString(16).padStart(2,"0"))).join("")}const H=t=>Object.prototype.toString.call(t).slice(8,-1),M=t=>"string"==typeof t||t instanceof String,k="0|[1-9]\\d*",z="\\d*[A-Z-][A-Z\\d-]*",K=`(?:${z}|${k})`,G=`(?:${z}|\\d+)`,F=`((?:${k})(?:\\.(?:${k})){2})(?:-(${`${K}(?:\\.${K})*`}))?(?:\\+(${`${G}(?:\\.${G})*`}))?`,W=new RegExp(`^(?:${k})$`),q=new RegExp(`^v?${F}$`,"i"),Z=new RegExp(`^${F}$`,"i"),X=(t,e=!1)=>{if(!M(t))throw new TypeError(`Expected String but got ${H(t)}.`);return(e?Z:q).test(t)},J=(t,e=!1)=>{if(!M(t))throw new TypeError(`Expected String but got ${H(t)}.`);if(!e&&!W.test(t))throw new Error(`${t} is not a stringified positive integer.`);let s;if(W.test(t)){if(s=parseInt(t,10),!Number.isSafeInteger(s))throw new RangeError(`${s} exceeds ${Number.MAX_SAFE_INTEGER}.`)}else s=t;return s},Q=(t,e=!1)=>{if(!M(t))throw new TypeError(`Expected String but got ${H(t)}.`);const s=X(t,!!e);let a,i,r,o,n;if(s){const s=e?Z:q,[,c,d,u]=t.match(s);[a,i,r]=c.split(".").map((t=>J(t))),d&&(o=d.split(".").map((t=>J(t,!0)))),u&&(n=u.split(".").map((t=>J(t,!0))))}return{version:t,matches:s,major:a,minor:i,patch:r,pre:o,build:n}};var Y=function(t,e,s,a){var i,r=arguments.length,o=r<3?e:null===a?a=Object.getOwnPropertyDescriptor(e,s):a;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)o=Reflect.decorate(t,e,s,a);else for(var n=t.length-1;n>=0;n--)(i=t[n])&&(o=(r<3?i(o):r>3?i(e,s,o):i(e,s))||o);return r>3&&o&&Object.defineProperty(e,s,o),o};let tt=class{constructor(t,e){this.boardStorage=t,this.memberStorage=e,i(this)}async isThereANewMinorOrMajor(t){const e=await this.memberStorage.read(t,D.POWER_UP_VERSION);if(!e)return!0;const s=Q(e),a=Q("0.9.3"),i=a.major>s.major||a.minor>s.minor;return!s||i}async showMenu(e){const s=await this.memberStorage.read(e,D.POWER_UP_VERSION),a=s?e.localizeKey("boardButtonPopupTitle",{oldVersion:s,newVersion:"0.9.3"}):e.localizeKey("boardButtonPopupTitleMissingVersion",{newVersion:"0.9.3"});return e.popup({title:a,url:`./release-notes.html?${await l.getOverrides(this.boardStorage,e)}&${await t(this.boardStorage,e)}`,args:{version:"0.9.3",localization:w},callback:this.storeNewVersion,height:65})}async storeNewVersion(t){await this.memberStorage.write(t,D.POWER_UP_VERSION,"0.9.3")}};tt=Y([a],tt);var et=tt,st=function(t,e,s,a){var i,r=arguments.length,o=r<3?e:null===a?a=Object.getOwnPropertyDescriptor(e,s):a;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)o=Reflect.decorate(t,e,s,a);else for(var n=t.length-1;n>=0;n--)(i=t[n])&&(o=(r<3?i(o):r>3?i(e,s,o):i(e,s))||o);return r>3&&o&&Object.defineProperty(e,s,o),o};let at=class{constructor(){this.cardStorage=new d,i(this)}async hasCurrentMemberVoted(t){const e=await this.cardStorage.read(t,d.VOTES);if(!e)return!1;return!!e[t.getContext().member]}async getVotes(t){return await this.cardStorage.read(t,d.VOTES)}async countVotesByCard(t,e){const s=await this.cardStorage.read(t,d.VOTES,e);return s?Object.keys(s).filter((t=>s[t])).length:0}async getMaxVotes(t){const e=await t.list("cards");return Math.ceil(e.cards.length/3)}async canCurrentMemberVote(t){if(await this.hasCurrentMemberVoted(t))return!0;const e=(await t.list("cards")).cards.map((t=>t.id));return await this.countVotesByMember(t,e)<await this.getMaxVotes(t)}async countVotesByMember(t,e){return(await Promise.all(e.map((async e=>{const s=await this.cardStorage.read(t,d.VOTES,e);if(!s)return 0;return s[t.getContext().member]?1:0})))).reduce(((t,e)=>t+e),0)}};at=st([a],at);var it=at;var rt=class extends v{constructor({w:t,config:e}){super({w:t,config:e}),this.t=t.TrelloPowerUp;const{hostname:s,port:a,defaultDuration:i}=this.config.production;this.baseUrl=`${s}${a?`:${a}`:""}`,this.discussion=new $(this.w,this.baseUrl,i),this.voting=new it,this.versionChecker=new et(this.boardStorage,this.memberStorage),this.elapsedCardBadge=new C(this.discussion),this.elapsedCardDetailBadge=new A(this.discussion),this.votingCardBadge=new N(this.w,this.baseUrl,this.voting,this.boardStorage,this.cardStorage),this.votingCardDetailBadge=new P(this.w,this.baseUrl,this.voting,this.boardStorage,this.cardStorage),this.capabilityHandlers=new g(this)}async handleVoting(e){if(!await this.voting.canCurrentMemberVote(e))return e.popup({title:"Leaner Coffee",url:`${this.baseUrl}/too_many_votes.html?${await l.getOverrides(this.boardStorage,e)}&${await t(this.boardStorage,e)}`,args:{maxVotes:await this.voting.getMaxVotes(e),localization:w},height:98});const s=await this.voting.getVotes(e)||{},a=await e.member("id","username","fullName","avatar");let i;s[a.id]?(delete s[a.id],i="removed"):(s[a.id]={username:a.username,fullName:a.fullName,avatar:a.avatar},i="added"),await this.cardStorage.saveVotes(e,s),await l.event(this.w,"voted",{outcome:i})}async stopAndStart(t){await l.event(this.w,"discussionStatusOverridden"),await this.discussion.end(t),await l.event(this.w,"discussionStatusChanged",{newStatus:"stopped"}),await this.discussion.start(t),await l.event(this.w,"discussionStatusChanged",{newStatus:"started"})}async handleDiscussion(t){if(await this.discussion.isOngoingOrPausedForAnotherCard(t)){const e=await this.boardStorage.getDiscussionStatus(t),s=await this.boardStorage.getDiscussionCardId(t);if(await this.discussion.hasNotBeenArchived(t,s)){const a=(await t.cards("id","name")).find((t=>t.id===s));return t.popup({callback:this.stopAndStart,title:"Leaner Coffee",url:`${this.baseUrl}/ongoing_or_paused.html?${await l.getOverrides(this.boardStorage,t)}`,args:{currentCardBeingDiscussed:a.name,currentDiscussionStatus:e,localization:w},height:120})}console.warn(`Card with id ${s} not found in current board, most likely archived. Cleaning up.`),await l.event(this.w,"discussionMenuOpened",{status:"ongoing other"}),await this.boardStorage.deleteMultiple(t,[b.DISCUSSION_STATUS,b.DISCUSSION_CARD_ID,b.DISCUSSION_STARTED_AT,b.DISCUSSION_PREVIOUS_ELAPSED,b.DISCUSSION_INTERVAL_ID])}let e,s=[];switch(!0){case await this.discussion.isOngoingFor(t):s=[{text:t.localizeKey("pauseTimer",{symbol:"❙ ❙"}),callback:async t=>{await l.event(this.w,"discussionStatusChanged",{newStatus:"paused"}),await this.discussion.pause(t),await t.closePopup(),await this.discussion.cardStorage.saveDiscussionButtonLabel(t,t.localizeKey("pausingTimer",{symbol:"❙ ❙"}))}},{text:t.localizeKey("endDiscussion",{symbol:"■"}),callback:async t=>{await l.event(this.w,"discussionStatusChanged",{newStatus:"stopped"}),await this.discussion.end(t),await t.closePopup(),await this.discussion.cardStorage.saveDiscussionButtonLabel(t,t.localizeKey("endingDiscussion",{symbol:"■"}))}}],e="ongoing";break;case await this.discussion.isPausedFor(t):s=[{text:t.localizeKey("resumeDiscussion",{symbol:"▶"}),callback:async t=>{await l.event(this.w,"discussionStatusChanged",{newStatus:"resumed"}),await this.discussion.start(t),await t.closePopup(),await this.discussion.cardStorage.saveDiscussionButtonLabel(t,t.localizeKey("resumingDiscussion",{symbol:"▶"}))}},{text:t.localizeKey("endDiscussion",{symbol:"■"}),callback:async t=>{await l.event(this.w,"discussionStatusChanged",{newStatus:"stopped"}),await this.discussion.end(t),await t.closePopup(),await this.discussion.cardStorage.saveDiscussionButtonLabel(t,t.localizeKey("endingDiscussion",{symbol:"■"}))}}],e="paused";break;default:s=[{text:t.localizeKey("startTimer",{symbol:"▶"}),callback:async t=>{await l.event(this.w,"discussionStatusChanged",{newStatus:"started"}),await this.discussion.start(t),await t.closePopup(),await this.discussion.cardStorage.saveDiscussionButtonLabel(t,t.localizeKey("startingTimer",{symbol:"▶"}))}}],await this.discussion.hasEverBeenDiscussed(t)?(s.push({text:t.localizeKey("resetDiscussion",{symbol:"↺"}),callback:async t=>{await l.event(this.w,"discussionStatusChanged",{newStatus:"reset"}),await this.discussion.reset(t),await t.closePopup(),await this.discussion.cardStorage.saveDiscussionButtonLabel(t,t.localizeKey("resettingDiscussion",{symbol:"↺"}))}}),e="discussed before"):e="never discussed"}return await l.event(this.w,"discussionMenuOpened",{status:e}),t.popup({title:"Leaner Coffee",items:s})}async getButtonLabel(t){let e=await this.discussion.cardStorage.getDiscussionButtonLabel(t);return e&&setTimeout((()=>{this.discussion.cardStorage.saveDiscussionButtonLabel(t)}),2e3),e=e||t.localizeKey("discussion"),e}async handlePowerupEnabled(t){const e=await t.organization("id"),s=await t.board("id"),a=await j(e.id),i=await j(s.id);await this.boardStorage.writeMultiple(t,{[b.POWER_UP_INSTALLATION_DATE]:(new Date).toISOString(),[b.ORGANISATION_HASH]:a,[b.BOARD_HASH]:i})}async start(){const t=this.t.initialize(this.capabilityHandlers.getAll(),{localization:w,helpfulStacks:!1});this.discussion.init(t),await navigator.locks.request("powerup_init",{ifAvailable:!0},(async e=>{null!==e&&(await this.boardStorage.getInitialised(t)||await this.handlePowerupEnabled(t))}));const e=await this.boardStorage.getOrganisationIdHash(t),s=await this.boardStorage.getBoardIdHash(t);window.Sentry&&window.Sentry.onLoad((async()=>{window.Sentry.setTags({organisationIdHash:e,boardIdHash:s})})),this.w.LeanerCoffeeAnalyticsReferrer="https://"+e,this.w.LeanerCoffeeAnalyticsHostname=s,this.w.LeanerCoffeeAnalyticsBeforeSend=l.beforeSend,window.setTimeout((async()=>{await l.pageview(this.w)}),0)}};new rt({w:window,config:{production:{hostname:"https://leaner-coffee.tatablack.net",defaultDuration:3e5,supportedLocales:["en","it"]}}}).start()}()}();
//# sourceMappingURL=index.214b8332e89cf633ef92.js.map