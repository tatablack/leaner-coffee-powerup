!function(){var t={836:function(t){function s(t,s){s=s||2;let e=t.toString(),a=0;return a=s-e.length+1,e=new Array(a).join("0").concat(e),e}t.exports=function(t,e){const a=e&&e.leading,i=e&&e.ms,r=t<0?-t:t,o=function(t,s){return s?t<0?"-":"":t<=-1e3?"-":""}(t,i),n=function(t){if("number"!=typeof t)throw new TypeError("Expected a number");return{days:Math.trunc(t/864e5),hours:Math.trunc(t/36e5)%24,minutes:Math.trunc(t/6e4)%60,seconds:Math.trunc(t/1e3)%60,ms:Math.trunc(t)%1e3}}(r),c=s(n.seconds);let u="";return n.days&&!u&&(u=o+n.days+":"+s(n.hours)+":"+s(n.minutes)+":"+c),n.hours&&!u&&(u=o+(a?s(n.hours):n.hours)+":"+s(n.minutes)+":"+c),u||(u=o+(a?s(n.minutes):n.minutes)+":"+c),i&&(u+="."+s(n.ms,3)),u}}},s={};function e(a){var i=s[a];if(void 0!==i)return i.exports;var r=s[a]={exports:{}};return t[a](r,r.exports,e),r.exports}e.n=function(t){var s=t&&t.__esModule?function(){return t.default}:function(){return t};return e.d(s,{a:s}),s},e.d=function(t,s){for(var a in s)e.o(s,a)&&!e.o(t,a)&&Object.defineProperty(t,a,{enumerable:!0,get:s[a]})},e.o=function(t,s){return Object.prototype.hasOwnProperty.call(t,s)},function(){"use strict";var t=class{constructor(t="member",s="private"){Object.assign(this,{scope:t,visibility:s})}read(t,s,e){return t.get(e??this.scope,this.visibility,s)}write(t,s,e,a){return t.set(a??this.scope,this.visibility,s,e)}writeMultiple(t,s,e){return t.set(e??this.scope,this.visibility,s)}delete(t,s,e){return t.remove(e??this.scope,this.visibility,s)}deleteMultiple(t,s,e){return t.remove(e??this.scope,this.visibility,s)}};class s extends t{constructor(){super("board","shared")}async getDiscussionStatus(t){return super.read(t,s.DISCUSSION_STATUS)}async getDiscussionCardId(t){return super.read(t,s.DISCUSSION_CARD_ID)}async getDiscussionStartedAt(t){return super.read(t,s.DISCUSSION_STARTED_AT)}async getDiscussionPreviousElapsed(t){return super.read(t,s.DISCUSSION_PREVIOUS_ELAPSED)}async getDiscussionIntervalId(t){return super.read(t,s.DISCUSSION_INTERVAL_ID)}async getPowerUpVersion(t){return super.read(t,s.POWER_UP_VERSION)}setPowerUpVersion(t,e){return super.write(t,s.POWER_UP_VERSION,e)}}s.DISCUSSION_STATUS="leancoffeeDiscussionStatus",s.DISCUSSION_CARD_ID="leancoffeeDiscussionCardId",s.DISCUSSION_STARTED_AT="leancoffeeDiscussionStartedAt",s.DISCUSSION_PREVIOUS_ELAPSED="leancoffeeDiscussionPreviousElapsed",s.DISCUSSION_INTERVAL_ID="leancoffeeDiscussionIntervalId",s.POWER_UP_VERSION="powerUpVersion";var a=s,i=e(836),r=e.n(i);var o=class{constructor(t){this.getText=async(t,s)=>r()(s),this.getColor=async t=>await this.discussion.isOngoingFor(t)?"orange":await this.discussion.isPausedFor(t)?"yellow":"light-gray",this.discussion=t,this.render=this.render.bind(this)}async render(t){const s=await this.discussion.getElapsed(t);return s?{text:await this.getText(t,s),color:await this.getColor(t)}:null}};var n=class extends o{constructor(){super(...arguments),this.render=async t=>{if("ENDED"!==await this.discussion.cardStorage.getDiscussionStatus(t))return null;const s=await super.render(t);return s.title=t.localizeKey("discussionDurationTitle"),s}}};var c=class{constructor(t,s,e){this.getVoters=async t=>{const s=await this.voting.getVotes(t)||{};return Object.values(s).reduce(((t,s)=>(s.username&&t.push({text:`${s.fullName} (${s.username})`,avatar:s.avatar}),t)),[])},this.baseUrl=t,this.voting=s,this.storage=e,this.render=this.render.bind(this)}async render(t){const s=await this.getVoters(t);if(!s.length)return null;const e=await this.voting.hasCurrentMemberVoted(t);return{text:s.length.toString(),color:e?"blue":null,icon:`${this.baseUrl}/assets/powerup/${e?"heart_white.svg":"heart.svg"}`}}};const{supportedLocales:u}={hostname:"https://leaner-coffee.tatablack.net",defaultDuration:3e5,supportedLocales:["en","it"]},l={defaultLocale:"en",supportedLocales:u,resourceUrl:"/i18n/{locale}.json"};var d=class extends c{constructor(){super(...arguments),this.clearVoters=async t=>{await this.storage.deleteVotes(t)},this.showVoters=async t=>{const s=await this.getVoters(t);s.length&&await t.popup({title:t.localizeKey("voters"),url:"./voters.html",args:{items:s,localization:l},callback:this.clearVoters})},this.render=async t=>{const s=await super.render(t);return s&&(s.title=t.localizeKey("voters"),delete s.icon,s.callback=this.showVoters),s}}};class h extends t{constructor(){super("card","shared")}getDiscussionStatus(t){return super.read(t,h.DISCUSSION_STATUS)}getDiscussionElapsed(t){return super.read(t,h.DISCUSSION_ELAPSED)}getDiscussionThumbs(t){return super.read(t,h.DISCUSSION_THUMBS)}getDiscussionButtonLabel(t){return super.read(t,h.DISCUSSION_BUTTON_LABEL)}saveDiscussionStatus(t,s,e){return super.write(t,h.DISCUSSION_STATUS,s,e)}saveDiscussionElapsed(t,s,e){return super.write(t,h.DISCUSSION_ELAPSED,s,e)}saveDiscussionThumbs(t,s){return super.write(t,h.DISCUSSION_THUMBS,s)}saveVotes(t,s){return super.write(t,h.VOTES,s)}deleteVotes(t){return super.delete(t,h.VOTES)}saveDiscussionButtonLabel(t,s){return super.write(t,h.DISCUSSION_BUTTON_LABEL,s)}deleteDiscussionThumbs(t){return super.delete(t,h.DISCUSSION_THUMBS)}}h.DISCUSSION_STATUS="leancoffeeDiscussionStatus",h.DISCUSSION_ELAPSED="leancoffeeDiscussionElapsed",h.DISCUSSION_THUMBS="leancoffeeDiscussionThumbs",h.VOTES="leancoffeeVotes",h.DISCUSSION_BUTTON_LABEL="discussionButtonLabel";var S=h;var g=class{constructor(t,s){this.w=t,this.baseUrl=s}async load(t){const s=await fetch(t),e=await s.arrayBuffer(),a=await this.audioContext.decodeAudioData(e),i=this.audioContext.createBufferSource();return i.buffer=a,i.connect(this.audioContext.destination),i}async play(t){this.audioContext=this.audioContext||new(AudioContext||this.w.webkitAudioContext);(await this.load(`${this.baseUrl}/${t.audio}`)).start()}open(t,s){new Notification(s,{body:t.text,icon:`${this.baseUrl}/assets/timer.png`})}show(t,s){"Notification"in this.w&&"denied"!==Notification.permission&&("granted"===Notification.permission?this.open(t,s):Notification.requestPermission((e=>{"granted"===e&&this.open(t,s)})))}};var w=class{constructor(t,s,e){this.init=t=>{this.p=t},this.getElapsedNotification=()=>({audio:"assets/looking_down.mp3",text:this.p.localizeKey("elapsedNotification")}),this.isOngoingOrPausedForAnotherCard=async t=>{const s=await this.boardStorage.getDiscussionStatus(t),e=await this.boardStorage.getDiscussionCardId(t);return["ONGOING","PAUSED"].includes(s)&&e!==t.getContext().card},this.hasEverBeenDiscussed=async t=>void 0!==await this.cardStorage.getDiscussionStatus(t),this.hasNotBeenArchived=async(t,s)=>!!(await t.cards("id","name")).find((t=>t.id===s)),this.isOngoingFor=async t=>"ONGOING"===await this.cardStorage.getDiscussionStatus(t),this.isPausedFor=async t=>"PAUSED"===await this.cardStorage.getDiscussionStatus(t),this.getElapsed=t=>this.cardStorage.getDiscussionElapsed(t),this.updateElapsed=async t=>{const s=await this.boardStorage.getDiscussionStartedAt(t);Date.now()-s>this.maxDiscussionDuration?await this.pause(t,!0):await this.saveElapsed(t)},this.saveElapsed=async t=>{const s=await this.boardStorage.getDiscussionCardId(t),e=await this.boardStorage.getDiscussionStartedAt(t),a=await this.boardStorage.getDiscussionPreviousElapsed(t)||0,i=e?Date.now()-e:0;await this.cardStorage.saveDiscussionElapsed(t,i+a,s)},this.start=async t=>{await this.boardStorage.writeMultiple(t,{[a.DISCUSSION_STATUS]:"ONGOING",[a.DISCUSSION_CARD_ID]:t.getContext().card,[a.DISCUSSION_STARTED_AT]:Date.now(),[a.DISCUSSION_PREVIOUS_ELAPSED]:await this.getElapsed(t),[a.DISCUSSION_INTERVAL_ID]:setInterval(this.updateElapsed,5e3,t)}),await this.cardStorage.saveDiscussionStatus(t,"ONGOING"),await this.cardStorage.deleteDiscussionThumbs(t)},this.pause=async(t,s=!1)=>{const e=await this.boardStorage.getDiscussionIntervalId(t),i=await this.boardStorage.getDiscussionCardId(t),r=(await t.cards("id","name")).find((t=>t.id===i)).name;if(clearInterval(e),await this.cardStorage.saveDiscussionStatus(t,"PAUSED"),await this.saveElapsed(t),await this.boardStorage.writeMultiple(t,{[a.DISCUSSION_STATUS]:"PAUSED",[a.DISCUSSION_STARTED_AT]:null,[a.DISCUSSION_PREVIOUS_ELAPSED]:await this.getElapsed(t),[a.DISCUSSION_INTERVAL_ID]:null}),s){const t=this.getElapsedNotification();await this.notifications.play(t),this.notifications.show(t,r)}},this.end=async t=>{const s=await this.boardStorage.getDiscussionIntervalId(t),e=await this.boardStorage.getDiscussionCardId(t);clearInterval(s);try{await this.cardStorage.saveDiscussionStatus(t,"ENDED",e),await this.saveElapsed(t),await this.cardStorage.deleteMultiple(t,[S.DISCUSSION_THUMBS],e),await this.boardStorage.deleteMultiple(t,[a.DISCUSSION_STATUS,a.DISCUSSION_CARD_ID,a.DISCUSSION_STARTED_AT,a.DISCUSSION_PREVIOUS_ELAPSED,a.DISCUSSION_INTERVAL_ID])}catch(t){throw new Error(t instanceof Error&&t.message?t.message:"Error while ending a discussion")}},this.reset=async t=>{await this.hasEverBeenDiscussed(t)&&await this.cardStorage.deleteMultiple(t,[S.DISCUSSION_STATUS,S.DISCUSSION_ELAPSED,S.DISCUSSION_THUMBS],t.getContext().card)},this.w=t,this.baseUrl=s,this.notifications=new g(this.w,this.baseUrl),this.maxDiscussionDuration=e,this.boardStorage=new a,this.cardStorage=new S}};var p=class{constructor(){this.hasCurrentMemberVoted=async t=>{const s=await this.cardStorage.read(t,S.VOTES);if(!s)return!1;return!!s[t.getContext().member]},this.getVotes=async t=>this.cardStorage.read(t,S.VOTES),this.countVotesByCard=async(t,s)=>{const e=await this.cardStorage.read(t,S.VOTES,s);return e?Object.keys(e).filter((t=>e[t])).length:0},this.getMaxVotes=async t=>{const s=await t.list("cards");return Math.ceil(s.cards.length/3)},this.canCurrentMemberVote=async t=>{if(await this.hasCurrentMemberVoted(t))return!0;const s=(await t.list("cards")).cards.map((t=>t.id));return await this.countVotesByMember(t,s)<await this.getMaxVotes(t)},this.countVotesByMember=async(t,s)=>(await Promise.all(s.map((async s=>{const e=await this.cardStorage.read(t,S.VOTES,s);if(!e)return 0;return e[t.getContext().member]?1:0})))).reduce(((t,s)=>t+s),0),this.cardStorage=new S}};var D=class{constructor(t){this.hasBeenUpdated=async t=>(this.storedVersion=await this.storage.getPowerUpVersion(t),!this.storedVersion||"0.8.0"!==this.storedVersion),this.showMenu=async t=>{const s=await this.storage.getPowerUpVersion(t);return t.popup({title:t.localizeKey("boardButtonPopupTitle",{oldVersion:s||"0.6.2",newVersion:"0.8.0"}),url:"./release-notes.html",args:{version:"0.8.0",localization:l},callback:this.storeNewVersion,height:65})},this.storeNewVersion=async t=>{await this.storage.setPowerUpVersion(t,"0.8.0")},this.storage=t}};class I{constructor({w:t,config:s}){this.isRunningInProduction=()=>!0,this.w=t,this.config=s,this.boardStorage=new a,this.cardStorage=new S}}var b=class extends I{constructor({w:t,config:s}){super({w:t,config:s}),this.handleVoting=async t=>{if(!await this.voting.canCurrentMemberVote(t))return t.popup({title:"Leaner Coffee",url:`${this.baseUrl}/too_many_votes.html`,args:{maxVotes:await this.voting.getMaxVotes(t),localization:l},height:98});const s=await this.voting.getVotes(t)||{},e=await t.member("id","username","fullName","avatar");return s[e.id]?delete s[e.id]:s[e.id]={username:e.username,fullName:e.fullName,avatar:e.avatar},this.cardStorage.saveVotes(t,s)},this.stopAndStart=async t=>{await this.discussion.end(t),await this.discussion.start(t)},this.handleDiscussion=async t=>{if(await this.discussion.isOngoingOrPausedForAnotherCard(t)){const s=await this.boardStorage.getDiscussionStatus(t),e=await this.boardStorage.getDiscussionCardId(t);if(await this.discussion.hasNotBeenArchived(t,e)){const a=(await t.cards("id","name")).find((t=>t.id===e));return t.popup({callback:this.stopAndStart,title:"Leaner Coffee",url:`${this.baseUrl}/ongoing_or_paused.html`,args:{currentCardBeingDiscussed:a.name,currentDiscussionStatus:s,localization:l},height:120})}console.warn(`Card with id ${e} not found in current board, most likely archived. Cleaning up.`),await this.boardStorage.deleteMultiple(t,[a.DISCUSSION_STATUS,a.DISCUSSION_CARD_ID,a.DISCUSSION_STARTED_AT,a.DISCUSSION_PREVIOUS_ELAPSED,a.DISCUSSION_INTERVAL_ID])}let s;switch(!0){case await this.discussion.isOngoingFor(t):s=[{text:t.localizeKey("pauseTimer",{symbol:"❙ ❙"}),callback:async t=>{await this.discussion.pause(t),await t.closePopup(),await this.discussion.cardStorage.saveDiscussionButtonLabel(t,t.localizeKey("pausingTimer",{symbol:"❙ ❙"}))}},{text:t.localizeKey("endDiscussion",{symbol:"■"}),callback:async t=>{await this.discussion.end(t),await t.closePopup(),await this.discussion.cardStorage.saveDiscussionButtonLabel(t,t.localizeKey("endingDiscussion",{symbol:"■"}))}}];break;case await this.discussion.isPausedFor(t):s=[{text:t.localizeKey("resumeDiscussion",{symbol:"▶"}),callback:async t=>{await this.discussion.start(t),await t.closePopup(),await this.discussion.cardStorage.saveDiscussionButtonLabel(t,t.localizeKey("resumingDiscussion",{symbol:"▶"}))}},{text:t.localizeKey("endDiscussion",{symbol:"■"}),callback:async t=>{await this.discussion.end(t),await t.closePopup(),await this.discussion.cardStorage.saveDiscussionButtonLabel(t,t.localizeKey("endingDiscussion",{symbol:"■"}))}}];break;default:s=[{text:t.localizeKey("startTimer",{symbol:"▶"}),callback:async t=>{await this.discussion.start(t),await t.closePopup(),await this.discussion.cardStorage.saveDiscussionButtonLabel(t,t.localizeKey("startingTimer",{symbol:"▶"}))}}],await this.discussion.hasEverBeenDiscussed(t)&&s.push({text:t.localizeKey("resetDiscussion",{symbol:"↺"}),callback:async t=>{await this.discussion.reset(t),await t.closePopup(),await this.discussion.cardStorage.saveDiscussionButtonLabel(t,t.localizeKey("resettingDiscussion",{symbol:"↺"}))}})}return t.popup({title:"Leaner Coffee",items:s})},this.getButtonLabel=async t=>{let s=await this.discussion.cardStorage.getDiscussionButtonLabel(t);return s&&setTimeout((()=>{this.discussion.cardStorage.saveDiscussionButtonLabel(t)}),2e3),s=s||t.localizeKey("discussion"),s},this.t=t.TrelloPowerUp;const{hostname:e,port:i,defaultDuration:r}=this.config.production;this.baseUrl=`${e}${i?`:${i}`:""}`,this.discussion=new w(this.w,this.baseUrl,r),this.voting=new p,this.updateChecker=new D(this.boardStorage),this.elapsedCardBadge=new o(this.discussion),this.elapsedCardDetailBadge=new n(this.discussion),this.votingCardBadge=new c(this.baseUrl,this.voting,this.cardStorage),this.votingCardDetailBadge=new d(this.baseUrl,this.voting,this.cardStorage)}start(){const t=this.t.initialize((s=this,{"board-buttons":async t=>await s.updateChecker.hasBeenUpdated(t)?[{icon:{dark:`${s.baseUrl}/assets/moka_white.svg`,light:`${s.baseUrl}/assets/moka.svg`},text:t.localizeKey("boardButtonLabel"),callback:s.updateChecker.showMenu}]:[],"card-back-section":async t=>void 0===await s.discussion.cardStorage.getDiscussionStatus(t)?null:{title:t.localizeKey("discussion"),icon:`${s.baseUrl}/assets/powerup/timer.svg`,content:{type:"iframe",url:t.signUrl(`${s.baseUrl}/discussion-ui.html`)}},"card-badges":async t=>[await s.elapsedCardBadge.render(t),await s.votingCardBadge.render(t)].filter((t=>t)),"card-buttons":async t=>[{icon:`${s.baseUrl}/assets/powerup/timer.svg`,text:await s.getButtonLabel(t),callback:s.handleDiscussion},{icon:`${s.baseUrl}/assets/powerup/heart.svg`,text:t.localizeKey("vote",{symbol:await s.voting.hasCurrentMemberVoted(t)?"☑":"☐"}),callback:s.handleVoting}],"card-detail-badges":async t=>[await s.elapsedCardDetailBadge.render(t),await s.votingCardDetailBadge.render(t)].filter((t=>t)),"list-actions":t=>Promise.resolve([{text:t.localizeKey("clearVotesFromList"),callback:async t=>((await t.list("cards")).cards.forEach((({id:e})=>{s.cardStorage.deleteMultiple(t,[S.VOTES],e)})),t.closePopup())}]),"list-sorters":t=>Promise.resolve([{text:t.localizeKey("sortByVote"),callback:async(t,e)=>({sortedIds:(await Promise.all(e.cards.map((async e=>({leanCoffeeVotes:await s.voting.countVotesByCard(t,e.id),id:e.id}))))).sort(((t,s)=>t.leanCoffeeVotes<s.leanCoffeeVotes?1:s.leanCoffeeVotes<t.leanCoffeeVotes?-1:0)).map((t=>t.id))})}]),"on-enable":t=>s.boardStorage.setPowerUpVersion(t,"0.8.0"),"show-settings":t=>t.popup({title:"Leaner Coffee v0.8.0",url:`${s.baseUrl}/settings.html`,height:184,args:{localization:l}})}),{localization:l,helpfulStacks:!this.isRunningInProduction()});var s;this.discussion.init(t)}};new b({w:window,config:{production:{hostname:"https://leaner-coffee.tatablack.net",defaultDuration:3e5,supportedLocales:["en","it"]}}}).start()}()}();
//# sourceMappingURL=main.5fde22772a19fd424286.js.map