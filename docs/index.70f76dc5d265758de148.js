try{let e="undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof globalThis?globalThis:"undefined"!=typeof self?self:{},t=(new e.Error).stack;t&&(e._sentryDebugIds=e._sentryDebugIds||{},e._sentryDebugIds[t]="5f5dd614-acc4-4003-b31c-d326201e7d88",e._sentryDebugIdIdentifier="sentry-dbid-5f5dd614-acc4-4003-b31c-d326201e7d88")}catch(e){}!function(){var e={262:function(e){function t(e,t){t=t||2;let a=e.toString(),i=0;return i=t-a.length+1,a=new Array(i).join("0").concat(a),a}e.exports=function(e,a){const i=a&&a.leading,s=a&&a.ms,r=e<0?-e:e,o=function(e,t){return t?e<0?"-":"":e<=-1e3?"-":""}(e,s),n=function(e){if("number"!=typeof e)throw new TypeError("Expected a number");return{days:Math.trunc(e/864e5),hours:Math.trunc(e/36e5)%24,minutes:Math.trunc(e/6e4)%60,seconds:Math.trunc(e/1e3)%60,ms:Math.trunc(e)%1e3}}(r),c=t(n.seconds);let d="";return n.days&&!d&&(d=o+n.days+":"+t(n.hours)+":"+t(n.minutes)+":"+c),n.hours&&!d&&(d=o+(i?t(n.hours):n.hours)+":"+t(n.minutes)+":"+c),d||(d=o+(i?t(n.minutes):n.minutes)+":"+c),s&&(d+="."+t(n.ms,3)),d}}},t={};function a(i){var s=t[i];if(void 0!==s)return s.exports;var r=t[i]={exports:{}};return e[i](r,r.exports,a),r.exports}a.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return a.d(t,{a:t}),t},a.d=function(e,t){for(var i in t)a.o(t,i)&&!a.o(e,i)&&Object.defineProperty(e,i,{enumerable:!0,get:t[i]})},a.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},function(){"use strict";const e=async(e,t)=>`organisationIdHash=${await e.read(t,d.ORGANISATION_HASH)}&boardIdHash=${await e.read(t,d.BOARD_HASH)}`,t=(e,t,a)=>{const i=a.value,s="AsyncFunction"===i.constructor.name,r=`Leaner Coffee Power-Up: error in ${t} (reported)`;return a.value=s?async function(...e){try{return await i.apply(this,e)}catch(e){console.warn(r),window.Sentry.captureException(e)}}:function(...e){try{return i.apply(this,e)}catch(e){console.warn(r),window.Sentry.captureException(e)}},a};function i(e){const a=e.prototype;return Object.getOwnPropertyNames(a).filter((e=>"function"==typeof a[e]&&"constructor"!==e)).forEach((e=>{const i=Object.getOwnPropertyDescriptor(a,e);if(i&&"function"==typeof i.value){const s=t(0,e,i);Object.defineProperty(a,e,s)}})),e}const s=e=>{const t=e.constructor.prototype;Object.getOwnPropertyNames(t).filter((e=>"function"==typeof t[e]&&"constructor"!==e)).forEach((a=>t[a]=t[a].bind(e)))};var r=function(e,t,a,i){var s,r=arguments.length,o=r<3?t:null===i?i=Object.getOwnPropertyDescriptor(t,a):i;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)o=Reflect.decorate(e,t,a,i);else for(var n=e.length-1;n>=0;n--)(s=e[n])&&(o=(r<3?s(o):r>3?s(t,a,o):s(t,a))||o);return r>3&&o&&Object.defineProperty(t,a,o),o};let o=class{constructor(e="member",t="private"){Object.assign(this,{scope:e,visibility:t}),s(this)}canWrite(e){return"member"===this.scope||e.memberCanWriteToModel(this.scope)}async isObserver(e){const t=await e.board("memberships"),a=await e.member("id"),i=t.memberships.find((e=>e.idMember===a.id));return i&&"observer"===i.memberType}read(e,t,a){return e.get(a??this.scope,this.visibility,t)}async write(e,t,a,i){!("memberCanWriteToModel"in e)||this.canWrite(e)?await e.set(i??this.scope,this.visibility,t,a):window.Sentry.captureException(new Error("Error while editing scope"),{contexts:{WriteOperation:{scope:this.scope,visibility:this.visibility,key:t,hasCardId:!!i,isObserver:await this.isObserver(e)}}})}async writeMultiple(e,t,a){!("memberCanWriteToModel"in e)||this.canWrite(e)?await e.set(a??this.scope,this.visibility,t):window.Sentry.captureException(new Error("Error while editing scope"),{contexts:{WriteOperation:{scope:this.scope,visibility:this.visibility,key:t,hasCardId:!!a,isObserver:await this.isObserver(e)}}})}async delete(e,t,a){if(!("memberCanWriteToModel"in e)||this.canWrite(e))return e.remove(a??this.scope,this.visibility,t);window.Sentry.captureException(new Error("Error while editing scope"),{contexts:{DeleteOperation:{scope:this.scope,visibility:this.visibility,key:t,hasCardId:!!a,isObserver:await this.isObserver(e)}}})}async deleteMultiple(e,t,a){if(!("memberCanWriteToModel"in e)||this.canWrite(e))return e.remove(a??this.scope,this.visibility,t);window.Sentry.captureException(new Error("Error while editing scope"),{contexts:{DeleteOperation:{scope:this.scope,visibility:this.visibility,key:t,hasCardId:!!a,isObserver:await this.isObserver(e)}}})}};o=r([i],o);var n=o;class c extends n{constructor(){super("board","shared")}}c.DISCUSSION_STATUS="leancoffeeDiscussionStatus",c.DISCUSSION_CARD_ID="leancoffeeDiscussionCardId",c.DISCUSSION_STARTED_AT="leancoffeeDiscussionStartedAt",c.DISCUSSION_PREVIOUS_ELAPSED="leancoffeeDiscussionPreviousElapsed",c.DISCUSSION_INTERVAL_ID="leancoffeeDiscussionIntervalId",c.POWER_UP_INSTALLATION_DATE="powerUpInstallationDate",c.ORGANISATION_HASH="organisationHash",c.BOARD_HASH="boardHash";var d=c;class l extends n{constructor(){super("card","shared")}}l.DISCUSSION_STATUS="leancoffeeDiscussionStatus",l.DISCUSSION_ELAPSED="leancoffeeDiscussionElapsed",l.DISCUSSION_THUMBS="leancoffeeDiscussionThumbs",l.VOTES="leancoffeeVotes",l.DISCUSSION_BUTTON_LABEL="discussionButtonLabel";var u=l;const h=e=>{const t=new URL(e);return t.protocol+t.hostname+(t.port?`:${t.port}`:"")+t.pathname};var S={beforeSend:(e,t)=>({...t,referrer:window.LeanerCoffeeAnalyticsReferrer,hostname:window.LeanerCoffeeAnalyticsHostname,url:h(t.url)}),pageview:async(e,t={})=>{e.umami?await e.umami.track((e=>({...e,...t}))):console.warn("Umami not available for pageview",t)},event:async(e,t,a)=>{e.umami?await e.umami.track(t,a):console.warn("Umami not available for event "+t,a)},getOverrides:async(e,t)=>{const a=await e.read(t,d.ORGANISATION_HASH),i=await e.read(t,d.BOARD_HASH);return`referrer=${encodeURIComponent("https://"+a)}&hostname=${i}`}};const{supportedLocales:w}={hostname:"https://leaner-coffee.tatablack.net",defaultDuration:3e5,supportedLocales:["en","it"]},p={defaultLocale:"en",supportedLocales:w,resourceUrl:"/i18n/{locale}.json"};var g=function(e,t,a,i){var s,r=arguments.length,o=r<3?t:null===i?i=Object.getOwnPropertyDescriptor(t,a):i;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)o=Reflect.decorate(e,t,a,i);else for(var n=e.length-1;n>=0;n--)(s=e[n])&&(o=(r<3?s(o):r>3?s(t,a,o):s(t,a))||o);return r>3&&o&&Object.defineProperty(t,a,o),o};let f=class{constructor(e){this.powerUp=e,s(this)}async boardButtonsHandler(e){return await this.powerUp.versionChecker.isThereANewMinorOrMajor(e)?[{icon:{dark:`${this.powerUp.baseUrl}/assets/moka_white.svg`,light:`${this.powerUp.baseUrl}/assets/moka.svg`},text:e.localizeKey("boardButtonLabel"),callback:this.powerUp.versionChecker.showMenu}]:[]}async cardBackSection(e){return void 0===await this.powerUp.discussion.cardStorage.read(e,u.DISCUSSION_STATUS)?null:{title:e.localizeKey("discussion"),icon:`${this.powerUp.baseUrl}/assets/powerup/timer.svg`,content:{type:"iframe",url:e.signUrl(`${this.powerUp.baseUrl}/discussion-ui.html?${await S.getOverrides(this.powerUp.boardStorage,e)}`)}}}async cardBadges(e){return[await this.powerUp.elapsedCardBadge.render(e),await this.powerUp.votingCardBadge.render(e)].filter((e=>e))}async cardButtons(e){return[{icon:`${this.powerUp.baseUrl}/assets/powerup/timer.svg`,text:await this.powerUp.getButtonLabel(e),callback:this.powerUp.handleDiscussion},{icon:`${this.powerUp.baseUrl}/assets/powerup/heart.svg`,text:e.localizeKey("vote",{symbol:await this.powerUp.voting.hasCurrentMemberVoted(e)?"☑":"☐"}),callback:this.powerUp.handleVoting}]}async cardDetailBadges(e){return[await this.powerUp.elapsedCardDetailBadge.render(e),await this.powerUp.votingCardDetailBadge.render(e)].filter((e=>e))}async listActions(e){return Promise.resolve([{text:e.localizeKey("clearVotesFromList"),callback:async e=>{(await e.list("cards")).cards.forEach((({id:t})=>{this.powerUp.cardStorage.deleteMultiple(e,[u.VOTES],t)})),await S.event(window,"listVotesCleared")}}])}async listSorters(e){return Promise.resolve([{text:e.localizeKey("sortByVote"),callback:async(e,t)=>{const a=(await Promise.all(t.cards.map((async t=>({leanCoffeeVotes:await this.powerUp.voting.countVotesByCard(e,t.id),id:t.id}))))).sort(((e,t)=>e.leanCoffeeVotes<t.leanCoffeeVotes?1:t.leanCoffeeVotes<e.leanCoffeeVotes?-1:0));return await S.event(window,"listVotesSorted"),{sortedIds:a.map((e=>e.id))}}}])}async onEnable(e){await navigator.locks.request("powerup_init",{ifAvailable:!0},(async t=>{const a=!!await this.powerUp.boardStorage.read(e,d.POWER_UP_INSTALLATION_DATE);null===t||a||a||await this.powerUp.handlePowerupEnabled(e)})),await S.event(window,"enabled")}async onDisable(){await S.event(window,"disabled")}async showSettings(e){return e.popup({title:"Leaner Coffee 0.9.5",url:`${this.powerUp.baseUrl}/settings.html?${await S.getOverrides(this.powerUp.boardStorage,e)}`,height:184,args:{localization:p}})}getAll(){return{"board-buttons":this.boardButtonsHandler,"card-back-section":this.cardBackSection,"card-badges":this.cardBadges,"card-buttons":this.cardButtons,"card-detail-badges":this.cardDetailBadges,"list-actions":this.listActions,"list-sorters":this.listSorters,"on-enable":this.onEnable,"on-disable":this.onDisable,"show-settings":this.showSettings}}};f=g([i],f);var b=f;class y extends n{constructor(){super("member","private")}}y.POWER_UP_VERSION="powerUpVersion";var I=y,O=function(e,t,a,i){var s,r=arguments.length,o=r<3?t:null===i?i=Object.getOwnPropertyDescriptor(t,a):i;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)o=Reflect.decorate(e,t,a,i);else for(var n=e.length-1;n>=0;n--)(s=e[n])&&(o=(r<3?s(o):r>3?s(t,a,o):s(t,a))||o);return r>3&&o&&Object.defineProperty(t,a,o),o};let D=class{constructor({w:e,config:t}){this.w=e,this.config=t,this.boardStorage=new d,this.cardStorage=new u,this.memberStorage=new I,s(this)}};D=O([i],D);var m=a(262),v=a.n(m),U=function(e,t,a,i){var s,r=arguments.length,o=r<3?t:null===i?i=Object.getOwnPropertyDescriptor(t,a):i;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)o=Reflect.decorate(e,t,a,i);else for(var n=e.length-1;n>=0;n--)(s=e[n])&&(o=(r<3?s(o):r>3?s(t,a,o):s(t,a))||o);return r>3&&o&&Object.defineProperty(t,a,o),o};let _=class{constructor(e){this.getText=async(e,t)=>v()(t),this.getColor=async e=>await this.discussion.isOngoingFor(e)?"orange":await this.discussion.isPausedFor(e)?"yellow":"light-gray",this.discussion=e,this.render=this.render.bind(this),s(this)}async render(e){const t=await this.discussion.getElapsed(e);return t?{text:await this.getText(e,t),color:await this.getColor(e)}:null}};_=U([i],_);var C=_;var A=class extends C{constructor(){super(...arguments),this.render=async e=>{if("ENDED"!==await this.discussion.cardStorage.read(e,u.DISCUSSION_STATUS))return null;const t=await super.render(e);return t.title=e.localizeKey("discussionDurationTitle"),t}}},T=function(e,t,a,i){var s,r=arguments.length,o=r<3?t:null===i?i=Object.getOwnPropertyDescriptor(t,a):i;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)o=Reflect.decorate(e,t,a,i);else for(var n=e.length-1;n>=0;n--)(s=e[n])&&(o=(r<3?s(o):r>3?s(t,a,o):s(t,a))||o);return r>3&&o&&Object.defineProperty(t,a,o),o};let E=class{constructor(e,t,a,i,r){this.getVoters=async e=>{const t=await this.voting.getVotes(e)||{};return Object.values(t).reduce(((e,t)=>(t.username&&e.push({text:`${t.fullName} (${t.username})`,avatar:t.avatar}),e)),[])},this.w=e,this.baseUrl=t,this.voting=a,this.boardStorage=i,this.cardStorage=r,this.render=this.render.bind(this),s(this)}async render(e){const t=await this.getVoters(e);if(!t.length)return null;const a=await this.voting.hasCurrentMemberVoted(e);return{text:t.length.toString(),color:a?"blue":null,icon:`${this.baseUrl}/assets/powerup/${a?"heart_white.svg":"heart.svg"}`}}};E=T([i],E);var N=E;var R=class extends N{constructor(){super(...arguments),this.clearVoters=async e=>{const t=await this.getVoters(e);await this.cardStorage.delete(e,u.VOTES),await S.event(this.w,"votesCleared",{total:t.length})},this.showVoters=async t=>{const a=await this.getVoters(t);a.length&&await t.popup({title:t.localizeKey("voters"),url:`./voters.html?${await S.getOverrides(this.boardStorage,t)}&${await e(this.boardStorage,t)}`,args:{items:a,localization:p},callback:this.clearVoters})},this.render=async e=>{const t=await super.render(e);return t&&(t.title=e.localizeKey("voters"),delete t.icon,t.callback=this.showVoters),t}}},P=function(e,t,a,i){var s,r=arguments.length,o=r<3?t:null===i?i=Object.getOwnPropertyDescriptor(t,a):i;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)o=Reflect.decorate(e,t,a,i);else for(var n=e.length-1;n>=0;n--)(s=e[n])&&(o=(r<3?s(o):r>3?s(t,a,o):s(t,a))||o);return r>3&&o&&Object.defineProperty(t,a,o),o};let V=class{constructor(e,t){this.w=e,this.baseUrl=t,s(this)}async load(e){const t=await fetch(e),a=await t.arrayBuffer(),i=await this.audioContext.decodeAudioData(a),s=this.audioContext.createBufferSource();return s.buffer=i,s.connect(this.audioContext.destination),s}async play(e){this.audioContext=this.audioContext||new(AudioContext||this.w.webkitAudioContext);(await this.load(`${this.baseUrl}/${e.audio}`)).start()}open(e,t){new Notification(t,{body:e.text,icon:`${this.baseUrl}/assets/timer.png`})}show(e,t){"Notification"in this.w&&"denied"!==Notification.permission&&("granted"===Notification.permission?this.open(e,t):Notification.requestPermission((a=>{"granted"===a&&this.open(e,t)})))}};V=P([i],V);var x=V,B=function(e,t,a,i){var s,r=arguments.length,o=r<3?t:null===i?i=Object.getOwnPropertyDescriptor(t,a):i;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)o=Reflect.decorate(e,t,a,i);else for(var n=e.length-1;n>=0;n--)(s=e[n])&&(o=(r<3?s(o):r>3?s(t,a,o):s(t,a))||o);return r>3&&o&&Object.defineProperty(t,a,o),o};let L=class{constructor(e,t,a){this.init=e=>{this.p=e},this.getElapsedNotification=()=>({audio:"assets/looking_down.mp3",text:this.p.localizeKey("elapsedNotification")}),this.isOngoingOrPausedForAnotherCard=async e=>{const t=await this.boardStorage.read(e,d.DISCUSSION_STATUS),a=await this.boardStorage.read(e,d.DISCUSSION_CARD_ID);return["ONGOING","PAUSED"].includes(t)&&a!==e.getContext().card},this.hasEverBeenDiscussed=async e=>void 0!==await this.cardStorage.read(e,u.DISCUSSION_STATUS),this.hasNotBeenArchived=async(e,t)=>!!(await e.cards("id","name")).find((e=>e.id===t)),this.isOngoingFor=async e=>"ONGOING"===await this.cardStorage.read(e,u.DISCUSSION_STATUS),this.isPausedFor=async e=>"PAUSED"===await this.cardStorage.read(e,u.DISCUSSION_STATUS),this.getElapsed=e=>this.cardStorage.read(e,u.DISCUSSION_ELAPSED),this.updateElapsed=async e=>{const t=await this.boardStorage.read(e,d.DISCUSSION_STARTED_AT),a=Date.now()-t;await this.saveElapsed(e),a>this.maxDiscussionDuration&&(await this.pause(e,!0),await S.event(this.w,"discussionStatusChanged",{newStatus:"ended"}))},this.saveElapsed=async e=>{const t=await this.boardStorage.read(e,d.DISCUSSION_CARD_ID),a=await this.boardStorage.read(e,d.DISCUSSION_STARTED_AT),i=await this.boardStorage.read(e,d.DISCUSSION_PREVIOUS_ELAPSED)||0,s=a?Date.now()-a:0;await this.cardStorage.write(e,u.DISCUSSION_ELAPSED,s+i,t)},this.start=async e=>{await this.boardStorage.writeMultiple(e,{[d.DISCUSSION_STATUS]:"ONGOING",[d.DISCUSSION_CARD_ID]:e.getContext().card,[d.DISCUSSION_STARTED_AT]:Date.now(),[d.DISCUSSION_PREVIOUS_ELAPSED]:await this.getElapsed(e),[d.DISCUSSION_INTERVAL_ID]:setInterval(this.updateElapsed,5e3,e)}),await this.cardStorage.write(e,u.DISCUSSION_STATUS,"ONGOING"),await this.cardStorage.delete(e,u.DISCUSSION_THUMBS)},this.pause=async(e,t=!1)=>{const a=await this.boardStorage.read(e,d.DISCUSSION_INTERVAL_ID),i=await this.boardStorage.read(e,d.DISCUSSION_CARD_ID),s=(await e.cards("id","name")).find((e=>e.id===i)).name;if(clearInterval(a),await this.cardStorage.write(e,u.DISCUSSION_STATUS,"PAUSED"),await this.saveElapsed(e),await this.boardStorage.writeMultiple(e,{[d.DISCUSSION_STATUS]:"PAUSED",[d.DISCUSSION_STARTED_AT]:null,[d.DISCUSSION_PREVIOUS_ELAPSED]:await this.getElapsed(e),[d.DISCUSSION_INTERVAL_ID]:null}),t){const e=this.getElapsedNotification();await this.notifications.play(e),this.notifications.show(e,s)}},this.end=async e=>{const t=await this.boardStorage.read(e,d.DISCUSSION_INTERVAL_ID),a=await this.boardStorage.read(e,d.DISCUSSION_CARD_ID);clearInterval(t),await this.cardStorage.write(e,u.DISCUSSION_STATUS,"ENDED",a),await this.saveElapsed(e),await this.cardStorage.deleteMultiple(e,[u.DISCUSSION_THUMBS],a),await this.boardStorage.deleteMultiple(e,[d.DISCUSSION_STATUS,d.DISCUSSION_CARD_ID,d.DISCUSSION_STARTED_AT,d.DISCUSSION_PREVIOUS_ELAPSED,d.DISCUSSION_INTERVAL_ID])},this.reset=async e=>{await this.hasEverBeenDiscussed(e)&&await this.cardStorage.deleteMultiple(e,[u.DISCUSSION_STATUS,u.DISCUSSION_ELAPSED,u.DISCUSSION_THUMBS],e.getContext().card)},this.w=e,this.baseUrl=t,this.notifications=new x(this.w,this.baseUrl),this.maxDiscussionDuration=a,this.boardStorage=new d,this.cardStorage=new u,s(this)}};L=B([i],L);var $=L;async function M(e){const t=(new TextEncoder).encode(e),a=await window.crypto.subtle.digest("SHA-256",t);return Array.from(new Uint8Array(a)).map((e=>e.toString(16).padStart(2,"0"))).join("")}const j=e=>Object.prototype.toString.call(e).slice(8,-1),k=e=>"string"==typeof e||e instanceof String,H="0|[1-9]\\d*",z="\\d*[A-Z-][A-Z\\d-]*",K=`(?:${z}|${H})`,W=`(?:${z}|\\d+)`,G=`((?:${H})(?:\\.(?:${H})){2})(?:-(${`${K}(?:\\.${K})*`}))?(?:\\+(${`${W}(?:\\.${W})*`}))?`,F=new RegExp(`^(?:${H})$`),q=new RegExp(`^v?${G}$`,"i"),Z=new RegExp(`^${G}$`,"i"),X=(e,t=!1)=>{if(!k(e))throw new TypeError(`Expected String but got ${j(e)}.`);return(t?Z:q).test(e)},J=(e,t=!1)=>{if(!k(e))throw new TypeError(`Expected String but got ${j(e)}.`);if(!t&&!F.test(e))throw new Error(`${e} is not a stringified positive integer.`);let a;if(F.test(e)){if(a=parseInt(e,10),!Number.isSafeInteger(a))throw new RangeError(`${a} exceeds ${Number.MAX_SAFE_INTEGER}.`)}else a=e;return a},Q=(e,t=!1)=>{if(!k(e))throw new TypeError(`Expected String but got ${j(e)}.`);const a=X(e,!!t);let i,s,r,o,n;if(a){const a=t?Z:q,[,c,d,l]=e.match(a);[i,s,r]=c.split(".").map((e=>J(e))),d&&(o=d.split(".").map((e=>J(e,!0)))),l&&(n=l.split(".").map((e=>J(e,!0))))}return{version:e,matches:a,major:i,minor:s,patch:r,pre:o,build:n}};var Y=function(e,t,a,i){var s,r=arguments.length,o=r<3?t:null===i?i=Object.getOwnPropertyDescriptor(t,a):i;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)o=Reflect.decorate(e,t,a,i);else for(var n=e.length-1;n>=0;n--)(s=e[n])&&(o=(r<3?s(o):r>3?s(t,a,o):s(t,a))||o);return r>3&&o&&Object.defineProperty(t,a,o),o};let ee=class{constructor(e,t){this.boardStorage=e,this.memberStorage=t,s(this)}async isThereANewMinorOrMajor(e){const t=await this.memberStorage.read(e,I.POWER_UP_VERSION);if(!t)return!0;const a=Q(t),i=Q("0.9.5"),s=i.major>a.major||i.minor>a.minor;return!a||s}async showMenu(t){const a=await this.memberStorage.read(t,I.POWER_UP_VERSION),i=a?t.localizeKey("boardButtonPopupTitle",{oldVersion:a,newVersion:"0.9.5"}):t.localizeKey("boardButtonPopupTitleMissingVersion",{newVersion:"0.9.5"});return t.popup({title:i,url:`./release-notes.html?${await S.getOverrides(this.boardStorage,t)}&${await e(this.boardStorage,t)}`,args:{version:"0.9.5",localization:p},callback:this.storeNewVersion,height:65})}async storeNewVersion(e){await this.memberStorage.write(e,I.POWER_UP_VERSION,"0.9.5")}};ee=Y([i],ee);var te=ee,ae=function(e,t,a,i){var s,r=arguments.length,o=r<3?t:null===i?i=Object.getOwnPropertyDescriptor(t,a):i;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)o=Reflect.decorate(e,t,a,i);else for(var n=e.length-1;n>=0;n--)(s=e[n])&&(o=(r<3?s(o):r>3?s(t,a,o):s(t,a))||o);return r>3&&o&&Object.defineProperty(t,a,o),o};let ie=class{constructor(){this.cardStorage=new u,s(this)}async hasCurrentMemberVoted(e){const t=await this.cardStorage.read(e,u.VOTES);if(!t)return!1;return!!t[e.getContext().member]}async getVotes(e){return await this.cardStorage.read(e,u.VOTES)}async countVotesByCard(e,t){const a=await this.cardStorage.read(e,u.VOTES,t);return a?Object.keys(a).filter((e=>a[e])).length:0}async getMaxVotes(e){const t=await e.list("cards");return Math.ceil(t.cards.length/3)}async canCurrentMemberVote(e){if(await this.hasCurrentMemberVoted(e))return!0;const t=(await e.list("cards")).cards.map((e=>e.id));return await this.countVotesByMember(e,t)<await this.getMaxVotes(e)}async countVotesByMember(e,t){return(await Promise.all(t.map((async t=>{const a=await this.cardStorage.read(e,u.VOTES,t);if(!a)return 0;return a[e.getContext().member]?1:0})))).reduce(((e,t)=>e+t),0)}};ie=ae([i],ie);var se=ie;var re=class extends D{constructor({w:e,config:t}){super({w:e,config:t}),this.t=e.TrelloPowerUp;const{hostname:a,port:i,defaultDuration:s}=this.config.production;this.baseUrl=`${a}${i?`:${i}`:""}`,this.discussion=new $(this.w,this.baseUrl,s),this.voting=new se,this.versionChecker=new te(this.boardStorage,this.memberStorage),this.elapsedCardBadge=new C(this.discussion),this.elapsedCardDetailBadge=new A(this.discussion),this.votingCardBadge=new N(this.w,this.baseUrl,this.voting,this.boardStorage,this.cardStorage),this.votingCardDetailBadge=new R(this.w,this.baseUrl,this.voting,this.boardStorage,this.cardStorage),this.capabilityHandlers=new b(this)}async handleVoting(t){if(!await this.voting.canCurrentMemberVote(t))return t.popup({title:"Leaner Coffee",url:`${this.baseUrl}/too_many_votes.html?${await S.getOverrides(this.boardStorage,t)}&${await e(this.boardStorage,t)}`,args:{maxVotes:await this.voting.getMaxVotes(t),localization:p},height:98});const a=await this.voting.getVotes(t)||{},i=await t.member("id","username","fullName","avatar");let s;a[i.id]?(delete a[i.id],s="removed"):(a[i.id]={username:i.username,fullName:i.fullName,avatar:i.avatar},s="added"),await this.cardStorage.write(t,u.VOTES,a),await S.event(this.w,"voted",{outcome:s})}async stopAndStart(e){await S.event(this.w,"discussionStatusOverridden"),await this.discussion.end(e),await S.event(this.w,"discussionStatusChanged",{newStatus:"stopped"}),await this.discussion.start(e),await S.event(this.w,"discussionStatusChanged",{newStatus:"started"})}async handleDiscussion(e){if(await this.discussion.isOngoingOrPausedForAnotherCard(e)){const t=await this.boardStorage.read(e,d.DISCUSSION_STATUS),a=await this.boardStorage.read(e,d.DISCUSSION_CARD_ID);if(await this.discussion.hasNotBeenArchived(e,a)){const i=(await e.cards("id","name")).find((e=>e.id===a));return e.popup({callback:this.stopAndStart,title:"Leaner Coffee",url:`${this.baseUrl}/ongoing_or_paused.html?${await S.getOverrides(this.boardStorage,e)}`,args:{currentCardBeingDiscussed:i.name,currentDiscussionStatus:t,localization:p},height:120})}console.warn(`Card with id ${a} not found in current board, most likely archived. Cleaning up.`),await S.event(this.w,"discussionMenuOpened",{status:"ongoing other"}),await this.boardStorage.deleteMultiple(e,[d.DISCUSSION_STATUS,d.DISCUSSION_CARD_ID,d.DISCUSSION_STARTED_AT,d.DISCUSSION_PREVIOUS_ELAPSED,d.DISCUSSION_INTERVAL_ID])}let t,a=[];switch(!0){case await this.discussion.isOngoingFor(e):a=[{text:e.localizeKey("pauseTimer",{symbol:"❙ ❙"}),callback:async e=>{await S.event(this.w,"discussionStatusChanged",{newStatus:"paused"}),await this.discussion.pause(e),await e.closePopup(),await this.discussion.cardStorage.write(e,u.DISCUSSION_BUTTON_LABEL,e.localizeKey("pausingTimer",{symbol:"❙ ❙"}))}},{text:e.localizeKey("endDiscussion",{symbol:"■"}),callback:async e=>{await S.event(this.w,"discussionStatusChanged",{newStatus:"stopped"}),await this.discussion.end(e),await e.closePopup(),await this.discussion.cardStorage.write(e,u.DISCUSSION_BUTTON_LABEL,e.localizeKey("endingDiscussion",{symbol:"■"}))}}],t="ongoing";break;case await this.discussion.isPausedFor(e):a=[{text:e.localizeKey("resumeDiscussion",{symbol:"▶"}),callback:async e=>{await S.event(this.w,"discussionStatusChanged",{newStatus:"resumed"}),await this.discussion.start(e),await e.closePopup(),await this.discussion.cardStorage.write(e,u.DISCUSSION_BUTTON_LABEL,e.localizeKey("resumingDiscussion",{symbol:"▶"}))}},{text:e.localizeKey("endDiscussion",{symbol:"■"}),callback:async e=>{await S.event(this.w,"discussionStatusChanged",{newStatus:"stopped"}),await this.discussion.end(e),await e.closePopup(),await this.discussion.cardStorage.write(e,u.DISCUSSION_BUTTON_LABEL,e.localizeKey("endingDiscussion",{symbol:"■"}))}}],t="paused";break;default:a=[{text:e.localizeKey("startTimer",{symbol:"▶"}),callback:async e=>{await S.event(this.w,"discussionStatusChanged",{newStatus:"started"}),await this.discussion.start(e),await e.closePopup(),await this.discussion.cardStorage.write(e,u.DISCUSSION_BUTTON_LABEL,e.localizeKey("startingTimer",{symbol:"▶"}))}}],await this.discussion.hasEverBeenDiscussed(e)?(a.push({text:e.localizeKey("resetDiscussion",{symbol:"↺"}),callback:async e=>{await S.event(this.w,"discussionStatusChanged",{newStatus:"reset"}),await this.discussion.reset(e),await e.closePopup(),await this.discussion.cardStorage.write(e,u.DISCUSSION_BUTTON_LABEL,e.localizeKey("resettingDiscussion",{symbol:"↺"}))}}),t="discussed before"):t="never discussed"}return await S.event(this.w,"discussionMenuOpened",{status:t}),e.popup({title:"Leaner Coffee",items:a})}async getButtonLabel(e){let t=await this.discussion.cardStorage.read(e,u.DISCUSSION_BUTTON_LABEL);return t&&setTimeout((()=>{this.discussion.cardStorage.write(e,u.DISCUSSION_BUTTON_LABEL,null)}),2e3),t=t||e.localizeKey("discussion"),t}async handlePowerupEnabled(e){const t=await e.organization("id"),a=await e.board("id"),i=await M(t.id),s=await M(a.id);await this.boardStorage.writeMultiple(e,{[d.POWER_UP_INSTALLATION_DATE]:(new Date).toISOString(),[d.ORGANISATION_HASH]:i,[d.BOARD_HASH]:s})}async start(){const e=this.t.initialize(this.capabilityHandlers.getAll(),{localization:p,helpfulStacks:!1});this.discussion.init(e),await navigator.locks.request("powerup_init",{ifAvailable:!0},(async t=>{null!==t&&(await this.boardStorage.read(e,d.POWER_UP_INSTALLATION_DATE)||await this.handlePowerupEnabled(e))}));const t=await this.boardStorage.read(e,d.ORGANISATION_HASH),a=await this.boardStorage.read(e,d.BOARD_HASH);window.Sentry&&window.Sentry.onLoad((async()=>{window.Sentry.setTags({organisationIdHash:t,boardIdHash:a})})),this.w.LeanerCoffeeAnalyticsReferrer="https://"+t,this.w.LeanerCoffeeAnalyticsHostname=a,this.w.LeanerCoffeeAnalyticsBeforeSend=S.beforeSend,window.setTimeout((async()=>{await S.pageview(this.w)}),0)}};new re({w:window,config:{production:{hostname:"https://leaner-coffee.tatablack.net",defaultDuration:3e5,supportedLocales:["en","it"]}}}).start()}()}();
//# sourceMappingURL=index.70f76dc5d265758de148.js.map